<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinar Impact Analyzer - Nuvemshop</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-surface: #0050B3;
            --primary-interactive: #0066E5;
            --primary-interactive-hover: #0050B3;
            --primary-text-low: #E6F0FF;
            --neutral-background: #FFFFFF;
            --neutral-surface: #F7F7F8;
            --neutral-surface-highlight: #EBEBED;
            --neutral-interactive: #E1E1E3;
            --neutral-text-low: #8C8C8C;
            --neutral-text-high: #14171A;
            --success-surface: #E6F9ED;
            --success-interactive: #00A650;
            --success-text-low: #006633;
            --warning-surface: #FFF4E6;
            --warning-interactive: #FF9500;
            --warning-text-low: #995900;
            --danger-surface: #FFE6E6;
            --danger-interactive: #E53935;
            --danger-text-low: #B71C1C;
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px;
            --space-5: 20px; --space-6: 24px; --space-8: 32px; --space-10: 40px;
            --radius-1: 4px; --radius-2: 8px; --radius-3: 12px; --radius-full: 9999px;
            --shadow-level-1: 0 1px 3px rgba(0, 0, 0, 0.08);
            --font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-caption: 12px; --font-size-body: 14px;
            --font-size-highlight: 16px; --font-size-title: 20px; --font-size-display: 28px;
            --font-weight-regular: 400; --font-weight-medium: 500; --font-weight-bold: 700;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background: var(--neutral-surface);
            min-height: 100vh;
            color: var(--neutral-text-high);
            font-size: var(--font-size-body);
            line-height: 1.5;
        }
        .app-header {
            background: var(--neutral-background);
            border-bottom: 1px solid var(--neutral-interactive);
            padding: var(--space-4) var(--space-6);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; gap: var(--space-3);
        }
        .logo { display: flex; align-items: center; gap: var(--space-2); }
        .logo-icon {
            width: 32px; height: 32px;
            background: var(--primary-interactive);
            border-radius: var(--radius-2);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: var(--font-weight-bold); font-size: 18px;
        }
        .logo-text { font-size: var(--font-size-highlight); font-weight: var(--font-weight-bold); }
        .logo-badge {
            background: var(--neutral-surface); color: var(--neutral-text-low);
            font-size: var(--font-size-caption); padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full); font-weight: var(--font-weight-medium);
        }
        .container { max-width: 1400px; margin: 0 auto; padding: var(--space-6); }
        .upload-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4); margin-bottom: var(--space-6);
        }
        .upload-card {
            background: var(--neutral-background);
            border: 2px dashed var(--neutral-interactive);
            border-radius: var(--radius-3); padding: var(--space-5);
            transition: all 0.2s ease;
        }
        .upload-card:hover { border-color: var(--primary-interactive); background: var(--primary-text-low); }
        .upload-card.loaded { border-color: var(--success-interactive); border-style: solid; background: var(--success-surface); }
        .upload-card h3 {
            font-size: var(--font-size-body); font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-3); display: flex; align-items: center; gap: var(--space-2);
        }
        .upload-card input[type="file"] { display: none; }
        .upload-label {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: var(--space-6); cursor: pointer; border-radius: var(--radius-2);
            background: var(--neutral-surface); transition: background 0.2s ease;
        }
        .upload-label:hover { background: var(--neutral-surface-highlight); }
        .upload-icon { font-size: 40px; margin-bottom: var(--space-3); }
        .upload-text { color: var(--neutral-text-low); text-align: center; }
        .file-info {
            margin-top: var(--space-3); padding: var(--space-3);
            background: var(--neutral-surface); border-radius: var(--radius-2);
            font-size: var(--font-size-caption); color: var(--success-text-low);
        }
        .btn-primary {
            display: block; width: 100%; padding: var(--space-4) var(--space-6);
            font-size: var(--font-size-highlight); font-weight: var(--font-weight-bold);
            color: white; background: var(--primary-interactive); border: none;
            border-radius: var(--radius-2); cursor: pointer;
            transition: background 0.2s ease; margin-bottom: var(--space-6);
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-interactive-hover); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
        .tabs {
            display: flex; gap: var(--space-1); background: var(--neutral-background);
            padding: var(--space-2); border-radius: var(--radius-3);
            box-shadow: var(--shadow-level-1); margin-bottom: var(--space-5); flex-wrap: wrap;
        }
        .tab {
            flex: 1; min-width: 100px; padding: var(--space-3) var(--space-4);
            border: none; background: transparent; border-radius: var(--radius-2);
            cursor: pointer; font-family: var(--font-family); font-size: var(--font-size-body);
            font-weight: var(--font-weight-medium); color: var(--neutral-text-low);
            transition: all 0.2s ease;
        }
        .tab:hover { background: var(--neutral-surface); color: var(--neutral-text-high); }
        .tab.active { background: var(--primary-interactive); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--space-4); margin-bottom: var(--space-6);
        }
        .metric-card {
            background: var(--neutral-background); border-radius: var(--radius-3);
            padding: var(--space-5); box-shadow: var(--shadow-level-1);
            border-left: 4px solid var(--primary-interactive);
        }
        .metric-card.success { border-left-color: var(--success-interactive); }
        .metric-card.warning { border-left-color: var(--warning-interactive); }
        .metric-card.danger { border-left-color: var(--danger-interactive); }
        .metric-value {
            font-size: var(--font-size-display); font-weight: var(--font-weight-bold);
            color: var(--neutral-text-high); line-height: 1.25;
        }
        .metric-label {
            font-size: var(--font-size-caption); color: var(--neutral-text-low);
            margin-top: var(--space-1); font-weight: var(--font-weight-medium);
        }
        .metric-delta { font-size: var(--font-size-caption); margin-top: var(--space-2); font-weight: var(--font-weight-medium); }
        .metric-delta.positive { color: var(--success-interactive); }
        .metric-delta.negative { color: var(--danger-interactive); }
        .charts-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: var(--space-5);
        }
        .charts-grid.single-col { grid-template-columns: 1fr; }
        .charts-grid.three-col { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: var(--neutral-background); border-radius: var(--radius-3);
            padding: var(--space-5); box-shadow: var(--shadow-level-1);
            min-height: 380px; position: relative; cursor: pointer;
            transition: box-shadow 0.2s ease;
        }
        .chart-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-title {
            font-size: var(--font-size-body); font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-4); color: var(--neutral-text-high);
        }
        .expand-hint {
            position: absolute; top: var(--space-3); right: var(--space-3);
            font-size: 16px; opacity: 0.4; transition: opacity 0.2s;
        }
        .chart-card:hover .expand-hint { opacity: 1; }
        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            padding: var(--space-6);
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--neutral-background); border-radius: var(--radius-3);
            width: 95vw; max-width: 1200px; max-height: 90vh;
            padding: var(--space-6); position: relative; overflow: auto;
        }
        .modal-close {
            position: absolute; top: var(--space-4); right: var(--space-4);
            background: var(--neutral-surface); border: none; border-radius: var(--radius-full);
            width: 36px; height: 36px; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .modal-close:hover { background: var(--neutral-surface-highlight); }
        .modal-chart { width: 100%; height: 70vh; }
        .alert {
            padding: var(--space-4); border-radius: var(--radius-2);
            margin-bottom: var(--space-5); display: flex; align-items: flex-start; gap: var(--space-3);
        }
        .alert-info { background: var(--primary-text-low); border-left: 4px solid var(--primary-interactive); }
        .alert-success { background: var(--success-surface); border-left: 4px solid var(--success-interactive); }
        .alert-warning { background: var(--warning-surface); border-left: 4px solid var(--warning-interactive); }
        .alert p { margin: 0; font-size: var(--font-size-body); }
        .table-container {
            max-height: 400px; overflow-y: auto; border-radius: var(--radius-2);
            border: 1px solid var(--neutral-interactive);
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: var(--font-size-body); }
        .data-table th {
            background: var(--neutral-surface); padding: var(--space-3) var(--space-4);
            text-align: left; font-weight: var(--font-weight-bold);
            font-size: var(--font-size-caption); text-transform: uppercase;
            position: sticky; top: 0; border-bottom: 1px solid var(--neutral-interactive);
        }
        .data-table td { padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--neutral-interactive); }
        .data-table tr:hover { background: var(--neutral-surface); }
        .section-title {
            font-size: var(--font-size-title); font-weight: var(--font-weight-bold);
            color: var(--neutral-text-high); margin: var(--space-8) 0 var(--space-4);
            padding-bottom: var(--space-3); border-bottom: 2px solid var(--neutral-interactive);
        }
        .section-subtitle { color: var(--neutral-text-low); font-size: var(--font-size-body); margin-bottom: var(--space-5); }
        .summary-box {
            background: var(--neutral-surface); border-radius: var(--radius-2);
            padding: var(--space-5); margin-top: var(--space-5);
        }
        .summary-box h4 { font-weight: var(--font-weight-bold); margin-bottom: var(--space-3); }
        .summary-box p { color: var(--neutral-text-low); line-height: 1.6; }
        .loading { display: none; text-align: center; padding: var(--space-10); }
        .loading.show { display: block; }
        .spinner {
            width: 48px; height: 48px; border: 4px solid var(--neutral-interactive);
            border-top-color: var(--primary-interactive); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto var(--space-4);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .results-section { display: none; }
        .results-section.show { display: block; }
        .instructions {
            background: var(--neutral-background); border-radius: var(--radius-3);
            padding: var(--space-8); box-shadow: var(--shadow-level-1);
        }
        .instructions h2 { font-size: var(--font-size-title); margin-bottom: var(--space-4); }
        .instructions p { color: var(--neutral-text-low); margin-bottom: var(--space-4); }
        .instructions table { width: 100%; border-collapse: collapse; margin: var(--space-5) 0; }
        .instructions th, .instructions td { padding: var(--space-3) var(--space-4); text-align: left; border-bottom: 1px solid var(--neutral-interactive); }
        .instructions th { background: var(--neutral-surface); font-weight: var(--font-weight-bold); font-size: var(--font-size-caption); text-transform: uppercase; }
        @media (max-width: 900px) {
            .upload-grid { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr !important; }
            .charts-grid.three-col { grid-template-columns: 1fr !important; }
            .tab { min-width: 70px; padding: var(--space-2) var(--space-3); font-size: var(--font-size-caption); }
            .metric-value { font-size: var(--font-size-title); }
            .modal-content { width: 98vw; padding: var(--space-4); }
            .modal-chart { height: 50vh; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <span class="logo-text">Webinar Impact Analyzer</span>
            </div>
            <span class="logo-badge">Lifecycle Team</span>
        </div>
    </header>

    <div class="container">
        <div class="upload-grid">
            <div class="upload-card" id="webinar-card">
                <h3>üìã Base de Participantes</h3>
                <label class="upload-label" for="webinar-file">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Clique para selecionar CSV</span>
                </label>
                <input type="file" id="webinar-file" accept=".csv,.txt" onchange="handleWebinarFile(this)">
                <div class="file-info" id="webinar-info" style="display: none;"></div>
            </div>
            <div class="upload-card" id="store-card">
                <h3>üè™ Base Total de Lojas</h3>
                <label class="upload-label" for="store-file">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Clique para selecionar CSV</span>
                </label>
                <input type="file" id="store-file" accept=".csv,.txt" onchange="handleStoreFile(this)">
                <div class="file-info" id="store-info" style="display: none;"></div>
            </div>
        </div>

        <button class="btn-primary" id="analyze-btn" disabled onclick="runAnalysis()">
            Analisar Impacto dos Webinars
        </button>

        <button class="btn-primary" id="export-btn" style="display: none; background: #00A650; margin-top: -20px;" onclick="exportData()">
            üì• Exportar Dados para Report
        </button>

        <div class="loading" id="loading"><div class="spinner"></div><p>Processando dados...</p></div>

        <div class="instructions" id="instructions">
            <h2>üëã Bem-vindo ao Webinar Impact Analyzer</h2>
            <p>Ferramenta para an√°lise de impacto dos webinars nas m√©tricas de neg√≥cio.</p>
            <table>
                <thead><tr><th>An√°lise</th><th>M√©tricas</th></tr></thead>
                <tbody>
                    <tr><td><strong>First Seller</strong></td><td>Taxa de convers√£o para primeira venda</td></tr>
                    <tr><td><strong>GMV</strong></td><td>Compara√ß√£o de GMV por status</td></tr>
                    <tr><td><strong>Status</strong></td><td>Matriz de transi√ß√£o detalhada</td></tr>
                    <tr><td><strong>Perfil</strong></td><td>Caracter√≠sticas dos participantes</td></tr>
                </tbody>
            </table>
            <p>Fa√ßa upload dos dois arquivos CSV para come√ßar.</p>
        </div>

        <div class="results-section" id="results">
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">üìà Vis√£o Geral</button>
                <button class="tab" onclick="showTab('h1')">üéØ First Seller</button>
                <button class="tab" onclick="showTab('h2')">üí∞ GMV</button>
                <button class="tab" onclick="showTab('h3')">üìä Status</button>
                <button class="tab" onclick="showTab('profile')">üë§ Perfil</button>
            </div>

            <div class="tab-content active" id="tab-overview">
                <div class="metrics-grid" id="overview-metrics"></div>
                <div class="charts-grid" id="overview-charts"></div>
            </div>

            <div class="tab-content" id="tab-h1">
                <h2 class="section-title">Convers√£o para First Seller</h2>
                <p class="section-subtitle">An√°lise baseada APENAS na coluna first_seller_at</p>
                <div class="alert alert-info">
                    <p>üìä <strong>L√≥gica:</strong><br>
                    <strong>Denominador:</strong> Campo vazio + first_seller_at POSTERIOR ao webinar = quem N√ÉO tinha FS no momento do webinar<br>
                    <strong>Numerador:</strong> APENAS quem tem first_seller_at POSTERIOR ao webinar (converteram ap√≥s)</p>
                </div>
                <div class="metrics-grid" id="h1-metrics"></div>
                <div class="charts-grid" id="h1-charts"></div>
                <div id="h1-table"></div>
            </div>

            <div class="tab-content" id="tab-h2">
                <h2 class="section-title">An√°lise de GMV</h2>
                <p class="section-subtitle">Compara√ß√£o de GMV m√©dio por status entre participantes e base geral</p>
                <div id="h2-summary"></div>
                <div class="metrics-grid" id="h2-metrics"></div>
                <div class="charts-grid" id="h2-charts"></div>
            </div>

            <div class="tab-content" id="tab-h3">
                <h2 class="section-title">Evolu√ß√£o de Status</h2>
                <p class="section-subtitle">An√°lise detalhada de transi√ß√£o: de onde vieram e para onde foram</p>
                <div class="metrics-grid" id="h3-metrics"></div>
                <div class="charts-grid" id="h3-charts"></div>
                <h3 class="section-title" style="font-size: var(--font-size-highlight);">Matriz de Transi√ß√£o</h3>
                <div id="h3-matrix"></div>
                <h3 class="section-title" style="font-size: var(--font-size-highlight);">Transi√ß√µes por Status Inicial</h3>
                <div id="h3-details"></div>
            </div>

            <div class="tab-content" id="tab-profile">
                <h2 class="section-title">Perfil dos Participantes</h2>
                <p class="section-subtitle">Caracter√≠sticas e comportamentos dos participantes dos webinars</p>
                <div class="metrics-grid" id="profile-metrics"></div>
                <div class="charts-grid" id="profile-charts"></div>
                <div id="profile-insights"></div>
            </div>
        </div>
    </div>

    <!-- Modal para gr√°ficos expandidos -->
    <div class="modal-overlay" id="chart-modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modal-chart-container" class="modal-chart"></div>
        </div>
    </div>

    <script>
        let webinarData = null;
        let storeData = null;
        let analysisResults = null;
        let chartConfigs = {}; // Armazena configura√ß√µes dos gr√°ficos para o modal

        function openModal(chartId) {
            const config = chartConfigs[chartId];
            if (!config) return;
            
            const modal = document.getElementById('chart-modal');
            const container = document.getElementById('modal-chart-container');
            
            // Ajusta layout para modal maior
            const modalLayout = {
                ...config.layout,
                height: window.innerHeight * 0.65,
                margin: { t: 60, r: 40, b: 60, l: 60 }
            };
            
            Plotly.newPlot(container, config.data, modalLayout, { responsive: true });
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('chart-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            Plotly.purge('modal-chart-container');
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        function createChart(containerId, data, layout, config = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Adiciona hint de expans√£o
            const parent = container.parentElement;
            if (parent && !parent.querySelector('.expand-hint')) {
                const hint = document.createElement('span');
                hint.className = 'expand-hint';
                hint.innerHTML = 'üîç';
                hint.title = 'Clique para expandir';
                parent.prepend(hint);
            }
            
            // Armazena config para o modal
            chartConfigs[containerId] = { data, layout: { ...PLOTLY_LAYOUT, ...layout } };
            
            // Cria gr√°fico
            Plotly.newPlot(containerId, data, { ...PLOTLY_LAYOUT, ...layout, height: 320 }, { responsive: true, ...config });
            
            // Adiciona evento de clique para abrir modal
            if (parent) {
                parent.onclick = () => openModal(containerId);
            }
        }

        const CHART_COLORS = {
            primary: '#0066E5', primaryLight: '#E6F0FF', secondary: '#8C8C8C',
            success: '#00A650', successLight: '#E6F9ED',
            warning: '#FF9500', warningLight: '#FFF4E6',
            danger: '#E53935', dangerLight: '#FFE6E6', neutral: '#F7F7F8'
        };

        const STATUS_ORDER = {
            '': -1, 'no-seller': 0, 'struggling-seller': 1, 'tiny-seller': 2,
            'small-seller': 3, 'medium-seller': 4, 'large-seller': 5, 'top-seller': 6
        };

        const STATUS_LIST = ['no-seller', 'struggling-seller', 'tiny-seller', 'small-seller', 'medium-seller', 'large-seller', 'top-seller'];
        const STATUS_LABELS = {
            'no-seller': 'No Seller', 'struggling-seller': 'Struggling', 'tiny-seller': 'Tiny',
            'small-seller': 'Small', 'medium-seller': 'Medium', 'large-seller': 'Large', 'top-seller': 'Top'
        };
        const STATUS_COLORS = {
            'no-seller': '#E53935', 'struggling-seller': '#FF9500', 'tiny-seller': '#FFB800',
            'small-seller': '#84CC16', 'medium-seller': '#00A650', 'large-seller': '#00B8A9', 'top-seller': '#0066E5'
        };

        const PLOTLY_LAYOUT = {
            font: { family: 'Geist, -apple-system, sans-serif', size: 12, color: '#14171A' },
            paper_bgcolor: 'white', plot_bgcolor: 'white',
            margin: { t: 50, r: 20, b: 50, l: 50 },
            colorway: ['#0066E5', '#00A650', '#FF9500', '#E53935', '#8C8C8C']
        };

        function parseDate(dateStr) {
            if (!dateStr || dateStr.toString().trim() === '') return null;
            const str = dateStr.toString().trim();
            const parts = str.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            return new Date(year, month, day);
        }

        function isEmptyField(value) {
            return value === null || value === undefined || value.toString().trim() === '';
        }

        function getWebinarMonthDate(monthStr) {
            if (!monthStr) return null;
            const monthNames = {
                'january': 0, 'february': 1, 'march': 2, 'april': 3,
                'may': 4, 'june': 5, 'july': 6, 'august': 7,
                'september': 8, 'october': 9, 'november': 10, 'december': 11
            };
            const match = monthStr.match(/(\d{4})/);
            if (!match) return null;
            const year = parseInt(match[1]);
            const lowerStr = monthStr.toLowerCase();
            for (const [name, num] of Object.entries(monthNames)) {
                if (lowerStr.includes(name)) {
                    return new Date(year, num, 1);
                }
            }
            return null;
        }

        function handleWebinarFile(input) {
            const file = input.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, delimiter: '\t', skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data[0] || !results.data[0].store_id) {
                        Papa.parse(file, {
                            header: true, skipEmptyLines: true,
                            complete: function(results2) {
                                webinarData = results2.data;
                                updateFileInfo('webinar', file.name, webinarData.length);
                            }
                        });
                    } else {
                        webinarData = results.data;
                        updateFileInfo('webinar', file.name, webinarData.length);
                    }
                }
            });
        }

        function handleStoreFile(input) {
            const file = input.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, delimiter: '\t', skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data[0] || !results.data[0].store_id) {
                        Papa.parse(file, {
                            header: true, skipEmptyLines: true,
                            complete: function(results2) {
                                storeData = processStoreData(results2.data);
                                updateFileInfo('store', file.name, storeData.length);
                            }
                        });
                    } else {
                        storeData = processStoreData(results.data);
                        updateFileInfo('store', file.name, storeData.length);
                    }
                }
            });
        }

        function processStoreData(data) {
            return data.map(row => {
                const keys = Object.keys(row);
                return {
                    store_id: row.store_id,
                    gmv_d30: parseFloat(row[keys[3]]) || 0,
                    gmv_d90: parseFloat(row[keys[4]]) || 0,
                    current_status: (row[keys[5]] || '').toLowerCase().trim(),
                    store_age_days: parseInt(row[keys[6]]) || 0
                };
            });
        }

        function updateFileInfo(type, filename, rows) {
            const card = document.getElementById(`${type}-card`);
            const info = document.getElementById(`${type}-info`);
            card.classList.add('loaded');
            info.style.display = 'block';
            info.innerHTML = `‚úÖ <strong>${filename}</strong> ‚Äî ${rows.toLocaleString()} registros`;
            checkReadyToAnalyze();
        }

        function checkReadyToAnalyze() {
            document.getElementById('analyze-btn').disabled = !(webinarData && storeData);
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        function runAnalysis() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('results').classList.remove('show');

            setTimeout(() => {
                try {
                    analysisResults = performAnalysis();
                    console.log('Analysis results:', analysisResults);
                    renderResults();
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('results').classList.add('show');
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Erro na an√°lise: ' + error.message);
                    document.getElementById('loading').classList.remove('show');
                }
            }, 100);
        }

        function performAnalysis() {
            // Processar dados de webinar
            const processedWebinar = webinarData.map(row => {
                const firstSellerRaw = row.first_seller_at;
                const firstSellerDate = parseDate(firstSellerRaw);
                const webinarMonthDate = getWebinarMonthDate(row['Data do Webinar (m√™s)']);
                
                // Campo vazio = nunca teve first seller
                const fieldIsEmpty = isEmptyField(firstSellerRaw);
                
                // First seller POSTERIOR ao webinar = converteu depois do webinar
                const firstSellerAfterWebinar = !fieldIsEmpty && firstSellerDate && webinarMonthDate && firstSellerDate > webinarMonthDate;
                
                // N√ÉO tinha first seller NO MOMENTO do webinar = vazio OU posterior
                const hadNoFirstSellerAtWebinar = fieldIsEmpty || firstSellerAfterWebinar;
                
                return {
                    ...row,
                    store_id: row.store_id,
                    webinar_month: row['Data do Webinar (m√™s)'] || '',
                    webinar_name: row.webinar_name || '',
                    webinar_status: row.webinar_status || '',
                    first_seller_raw: firstSellerRaw,
                    first_seller_date: firstSellerDate,
                    webinar_month_date: webinarMonthDate,
                    field_is_empty: fieldIsEmpty,
                    first_seller_after_webinar: firstSellerAfterWebinar,
                    had_no_first_seller_at_webinar: hadNoFirstSellerAtWebinar,
                    created_at: row.created_at || '',
                    created_date: parseDate(row.created_at),
                    status_at_webinar: (row['M√°x. Seller Segment Mes Webinar'] || '').toLowerCase().trim()
                };
            });

            console.log('Sample webinar data:', processedWebinar.slice(0, 5));
            console.log('Campo vazio:', processedWebinar.filter(r => r.field_is_empty).length);
            console.log('First seller ap√≥s webinar:', processedWebinar.filter(r => r.first_seller_after_webinar).length);
            console.log('Total sem FS no webinar:', processedWebinar.filter(r => r.had_no_first_seller_at_webinar).length);

            // Criar mapa de participantes (lojas √∫nicas)
            const participantMap = new Map();
            processedWebinar.forEach(row => {
                const storeId = row.store_id;
                if (!storeId) return;
                
                if (!participantMap.has(storeId)) {
                    participantMap.set(storeId, {
                        store_id: storeId,
                        webinar_count: 0,
                        first_webinar_month: row.webinar_month,
                        first_webinar_date: row.webinar_month_date,
                        first_seller_raw: row.first_seller_raw,
                        first_seller_date: row.first_seller_date,
                        field_is_empty: row.field_is_empty,
                        first_seller_after_webinar: row.first_seller_after_webinar,
                        had_no_first_seller_at_webinar: row.had_no_first_seller_at_webinar,
                        created_date: row.created_date,
                        status_at_webinar: row.status_at_webinar
                    });
                }
                participantMap.get(storeId).webinar_count++;
            });

            // Merge com dados de loja
            const participants = [];
            const control = [];

            storeData.forEach(store => {
                if (participantMap.has(store.store_id)) {
                    const p = participantMap.get(store.store_id);
                    
                    // Converteu = tinha first_seller_at AP√ìS o webinar (apenas isso)
                    const convertedToSeller = p.first_seller_after_webinar === true;
                    
                    participants.push({
                        ...store,
                        ...p,
                        current_status: store.current_status || '',
                        converted_to_seller: convertedToSeller
                    });
                } else {
                    control.push(store);
                }
            });

            console.log('Participants sem FS no webinar:', participants.filter(p => p.had_no_first_seller_at_webinar).length);
            console.log('Participants converteram:', participants.filter(p => p.converted_to_seller).length);

            const h1 = analyzeFirstSeller(participants, processedWebinar);
            const h2 = analyzeGMV(participants, control, storeData);
            const h3 = analyzeStatusEvolution(participants, control);
            const profile = analyzeProfile(participants, processedWebinar);

            return {
                participants, control, webinarData: processedWebinar,
                h1, h2, h3, profile,
                overview: {
                    participantCount: participants.length,
                    controlCount: control.length,
                    webinarCount: new Set(processedWebinar.map(r => r.webinar_name).filter(n => n)).size,
                    monthCount: new Set(processedWebinar.map(r => r.webinar_month).filter(m => m)).size,
                    totalParticipations: processedWebinar.length
                }
            };
        }

        function analyzeFirstSeller(participants, webinarData) {
            // An√°lise por m√™s
            const byMonth = {};
            const monthOrder = [];
            
            webinarData.forEach(row => {
                const month = row.webinar_month;
                if (!month) return;
                
                if (!byMonth[month]) {
                    byMonth[month] = {
                        month,
                        stores: new Map(),
                        webinarDate: row.webinar_month_date
                    };
                    monthOrder.push(month);
                }
                
                // S√≥ conta primeira participa√ß√£o de cada loja no m√™s
                if (!byMonth[month].stores.has(row.store_id)) {
                    byMonth[month].stores.set(row.store_id, {
                        field_is_empty: row.field_is_empty,
                        first_seller_after_webinar: row.first_seller_after_webinar,
                        had_no_first_seller_at_webinar: row.had_no_first_seller_at_webinar,
                        first_seller_date: row.first_seller_date,
                        webinar_date: row.webinar_month_date
                    });
                }
            });

            // Ordenar meses
            const sortedMonths = monthOrder.sort((a, b) => {
                const getNum = m => parseInt((m.match(/Month\s+(\d+)/) || [0, 0])[1]);
                return getNum(a) - getNum(b);
            });

            // Buscar status atual e dados das lojas
            const storeData = new Map();
            participants.forEach(p => {
                storeData.set(p.store_id, {
                    current_status: p.current_status,
                    first_seller_after_webinar: p.first_seller_after_webinar
                });
            });

            const monthlyData = sortedMonths.map(month => {
                const data = byMonth[month];
                let total = 0;
                let withoutFirstSeller = 0;  // campo vazio + first_seller ap√≥s webinar
                let fieldEmpty = 0;
                let afterWebinar = 0;

                data.stores.forEach((rowData, storeId) => {
                    total++;
                    
                    // Denominador: n√£o tinha FS no momento do webinar
                    // = campo vazio OU first_seller posterior ao webinar
                    if (rowData.had_no_first_seller_at_webinar) {
                        withoutFirstSeller++;
                        
                        if (rowData.field_is_empty) fieldEmpty++;
                        if (rowData.first_seller_after_webinar) afterWebinar++;
                    }
                });

                // Numerador = APENAS quem teve first_seller AP√ìS o webinar
                const converted = afterWebinar;
                const rate = withoutFirstSeller > 0 ? (converted / withoutFirstSeller * 100) : 0;

                return {
                    month: month.replace('Month ', 'M').split(' - ')[0],
                    fullMonth: month,
                    total,
                    withoutFirstSeller,
                    fieldEmpty,
                    afterWebinar,
                    converted,
                    conversionRate: rate
                };
            });

            // Totais gerais
            const totalFieldEmpty = participants.filter(p => p.field_is_empty).length;
            const totalAfterWebinar = participants.filter(p => p.first_seller_after_webinar).length;
            const totalWithoutFS = participants.filter(p => p.had_no_first_seller_at_webinar).length;
            
            // Numerador = APENAS quem teve first_seller AP√ìS o webinar
            const totalConverted = totalAfterWebinar;
            const overallRate = totalWithoutFS > 0 ? (totalConverted / totalWithoutFS * 100) : 0;

            console.log('H1 Results:', { 
                totalWithoutFS, totalConverted, overallRate, 
                totalFieldEmpty, totalAfterWebinar, monthlyData 
            });

            return {
                byMonth: monthlyData,
                total: participants.length,
                withoutFirstSeller: totalWithoutFS,
                fieldEmpty: totalFieldEmpty,
                afterWebinar: totalAfterWebinar,
                converted: totalConverted,
                overallRate
            };
        }

        function analyzeGMV(participants, control, allStores) {
            const gmvByStatus = {};
            
            STATUS_LIST.forEach(status => {
                const pValues = participants.filter(p => p.current_status === status).map(p => p.gmv_d30).filter(v => v > 0);
                const allValues = allStores.filter(s => s.current_status === status).map(s => s.gmv_d30).filter(v => v > 0);
                
                const pStats = calculateStats(pValues);
                const allStats = calculateStats(allValues);
                
                gmvByStatus[status] = {
                    participants: pStats,
                    allStores: allStats,
                    diffPct: allStats.mean > 0 ? ((pStats.mean - allStats.mean) / allStats.mean * 100) : 0
                };
            });

            const pGmv = participants.map(p => p.gmv_d30).filter(v => v > 0);
            const allGmv = allStores.map(s => s.gmv_d30).filter(v => v > 0);
            
            const pStats = calculateStats(pGmv);
            const allStats = calculateStats(allGmv);
            const cStats = calculateStats(control.map(c => c.gmv_d30).filter(v => v > 0));

            let aboveAvgCount = 0;
            let totalWithStatus = 0;
            
            participants.forEach(p => {
                if (p.current_status && gmvByStatus[p.current_status] && p.gmv_d30 > 0) {
                    totalWithStatus++;
                    if (p.gmv_d30 > gmvByStatus[p.current_status].allStores.mean) {
                        aboveAvgCount++;
                    }
                }
            });

            return {
                participants: pStats, allStores: allStats, control: cStats,
                byStatus: gmvByStatus,
                aboveAvgCount,
                aboveAvgPct: totalWithStatus > 0 ? (aboveAvgCount / totalWithStatus * 100) : 0,
                diffPct: allStats.mean > 0 ? ((pStats.mean - allStats.mean) / allStats.mean * 100) : 0
            };
        }

        function analyzeStatusEvolution(participants, control) {
            const transitions = { upgrade: 0, maintained: 0, downgrade: 0, unknown: 0 };
            const transitionMatrix = {};
            STATUS_LIST.forEach(from => {
                transitionMatrix[from] = {};
                STATUS_LIST.forEach(to => { transitionMatrix[from][to] = 0; });
            });

            const transitionsByInitial = {};
            STATUS_LIST.forEach(status => {
                transitionsByInitial[status] = { total: 0, upgrade: 0, maintained: 0, downgrade: 0, destinations: {} };
                STATUS_LIST.forEach(dest => { transitionsByInitial[status].destinations[dest] = 0; });
            });

            participants.forEach(p => {
                const before = p.status_at_webinar;
                const after = p.current_status;
                const beforeNum = STATUS_ORDER[before];
                const afterNum = STATUS_ORDER[after];

                if (beforeNum === undefined || afterNum === undefined || beforeNum < 0 || afterNum < 0) {
                    transitions.unknown++;
                    return;
                }

                if (transitionMatrix[before]) transitionMatrix[before][after]++;
                if (transitionsByInitial[before]) {
                    transitionsByInitial[before].total++;
                    transitionsByInitial[before].destinations[after]++;
                    if (afterNum > beforeNum) { transitions.upgrade++; transitionsByInitial[before].upgrade++; }
                    else if (afterNum < beforeNum) { transitions.downgrade++; transitionsByInitial[before].downgrade++; }
                    else { transitions.maintained++; transitionsByInitial[before].maintained++; }
                }
            });

            const total = transitions.upgrade + transitions.maintained + transitions.downgrade;
            const pDist = {}, cDist = {};
            STATUS_LIST.forEach(s => {
                pDist[s] = participants.filter(p => p.current_status === s).length;
                cDist[s] = control.filter(c => c.current_status === s).length;
            });

            return {
                transitions, total,
                upgradeRate: total > 0 ? (transitions.upgrade / total * 100) : 0,
                maintainedRate: total > 0 ? (transitions.maintained / total * 100) : 0,
                downgradeRate: total > 0 ? (transitions.downgrade / total * 100) : 0,
                transitionMatrix, transitionsByInitial, participantsDist: pDist, controlDist: cDist
            };
        }

        function analyzeProfile(participants, webinarData) {
            const ages = participants.map(p => p.store_age_days).filter(a => a > 0);
            const ageCategories = { '0-30 dias': 0, '31-90 dias': 0, '91-180 dias': 0, '181-365 dias': 0, '1-2 anos': 0, '2+ anos': 0 };
            ages.forEach(age => {
                if (age <= 30) ageCategories['0-30 dias']++;
                else if (age <= 90) ageCategories['31-90 dias']++;
                else if (age <= 180) ageCategories['91-180 dias']++;
                else if (age <= 365) ageCategories['181-365 dias']++;
                else if (age <= 730) ageCategories['1-2 anos']++;
                else ageCategories['2+ anos']++;
            });

            const timeToFirstSeller = [];
            const timeCategories = { '0-30 dias': 0, '31-60 dias': 0, '61-90 dias': 0, '91-120 dias': 0, '121-180 dias': 0, '181-365 dias': 0, '365+ dias': 0 };
            
            participants.forEach(p => {
                if (p.created_date && p.first_seller_date && p.first_seller_date > p.created_date) {
                    const days = Math.floor((p.first_seller_date - p.created_date) / (1000 * 60 * 60 * 24));
                    if (days >= 0 && days < 3650) {
                        timeToFirstSeller.push(days);
                        if (days <= 30) timeCategories['0-30 dias']++;
                        else if (days <= 60) timeCategories['31-60 dias']++;
                        else if (days <= 90) timeCategories['61-90 dias']++;
                        else if (days <= 120) timeCategories['91-120 dias']++;
                        else if (days <= 180) timeCategories['121-180 dias']++;
                        else if (days <= 365) timeCategories['181-365 dias']++;
                        else timeCategories['365+ dias']++;
                    }
                }
            });

            const statusAtWebinar = {};
            STATUS_LIST.forEach(s => { statusAtWebinar[s] = participants.filter(p => p.status_at_webinar === s).length; });
            statusAtWebinar['sem status'] = participants.filter(p => !p.status_at_webinar || p.status_at_webinar === '').length;

            const participationType = { 'live': 0, 'on-demand': 0, 'registered': 0, 'outro': 0 };
            webinarData.forEach(row => {
                const status = (row.webinar_status || '').toLowerCase();
                if (participationType[status] !== undefined) participationType[status]++;
                else participationType['outro']++;
            });

            const webinarCountDist = {};
            participants.forEach(p => {
                const count = p.webinar_count || 1;
                const key = count >= 5 ? '5+' : count.toString();
                webinarCountDist[key] = (webinarCountDist[key] || 0) + 1;
            });

            const webinarsByMonth = {};
            webinarData.forEach(row => {
                const month = row.webinar_month;
                if (!month) return;
                if (!webinarsByMonth[month]) webinarsByMonth[month] = new Set();
                webinarsByMonth[month].add(row.store_id);
            });
            
            const avgWebinarsByMonth = Object.entries(webinarsByMonth).map(([month, stores]) => {
                const storeParticipations = {};
                webinarData.filter(r => r.webinar_month === month).forEach(r => {
                    storeParticipations[r.store_id] = (storeParticipations[r.store_id] || 0) + 1;
                });
                return {
                    month: month.replace('Month ', 'M').split(' - ')[0],
                    fullMonth: month,
                    uniqueStores: stores.size,
                    avgWebinars: Object.values(storeParticipations).reduce((a,b) => a+b, 0) / stores.size
                };
            }).sort((a, b) => parseInt(a.month.replace('M', '')) - parseInt(b.month.replace('M', '')));

            const webinarCounts = {};
            webinarData.forEach(row => {
                if (row.webinar_name) webinarCounts[row.webinar_name] = (webinarCounts[row.webinar_name] || 0) + 1;
            });
            const topWebinars = Object.entries(webinarCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            return {
                ageCategories, ageStats: calculateStats(ages),
                timeToFirstSeller, timeCategories, timeToFirstSellerStats: calculateStats(timeToFirstSeller),
                statusAtWebinar, participationType, webinarCountDist,
                avgWebinarsByMonth, topWebinars, totalParticipants: participants.length
            };
        }

        function calculateStats(arr) {
            if (!arr || arr.length === 0) return { mean: 0, median: 0, std: 0, count: 0 };
            const sorted = [...arr].sort((a, b) => a - b);
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const median = sorted[Math.floor(sorted.length / 2)];
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
            return { mean, median, std: Math.sqrt(variance), count: arr.length };
        }

        function renderResults() {
            renderOverview();
            renderH1();
            renderH2();
            renderH3();
            renderProfile();
            
            // Mostrar bot√£o de exportar
            document.getElementById('export-btn').style.display = 'block';
        }

        function exportData() {
            // Preparar dados para exporta√ß√£o
            const exportData = {
                overview: analysisResults.overview,
                h1: analysisResults.h1,
                h2: {
                    participants: analysisResults.h2.participants,
                    allStores: analysisResults.h2.allStores,
                    control: analysisResults.h2.control,
                    diffPct: analysisResults.h2.diffPct,
                    aboveAvgPct: analysisResults.h2.aboveAvgPct,
                    byStatus: analysisResults.h2.byStatus
                },
                h3: {
                    total: analysisResults.h3.total,
                    transitions: analysisResults.h3.transitions,
                    upgradeRate: analysisResults.h3.upgradeRate,
                    maintainedRate: analysisResults.h3.maintainedRate,
                    downgradeRate: analysisResults.h3.downgradeRate,
                    transitionMatrix: analysisResults.h3.transitionMatrix,
                    transitionsByInitial: analysisResults.h3.transitionsByInitial,
                    participantsDist: analysisResults.h3.participantsDist,
                    controlDist: analysisResults.h3.controlDist
                },
                profile: analysisResults.profile
            };

            const jsonStr = JSON.stringify(exportData, null, 2);
            
            // Copiar para clipboard
            navigator.clipboard.writeText(jsonStr).then(() => {
                alert('‚úÖ Dados copiados para a √°rea de transfer√™ncia!\n\nAgora abra o arquivo report.html e cole no lugar de REPORT_DATA.');
            }).catch(() => {
                // Fallback: download do arquivo
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'webinar-report-data.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('üì• Arquivo JSON baixado!\n\nAbra o arquivo e copie o conte√∫do para report.html');
            });
        }

        function renderOverview() {
            const o = analysisResults.overview;
            const h1 = analysisResults.h1;
            const h2 = analysisResults.h2;
            const h3 = analysisResults.h3;

            document.getElementById('overview-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${o.participantCount.toLocaleString()}</div><div class="metric-label">Lojas Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${o.controlCount.toLocaleString()}</div><div class="metric-label">Grupo de Controle</div></div>
                <div class="metric-card"><div class="metric-value">${o.totalParticipations.toLocaleString()}</div><div class="metric-label">Total Participa√ß√µes</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.overallRate.toFixed(1)}%</div><div class="metric-label">Convers√£o First Seller</div><div class="metric-delta">${h1.converted} de ${h1.withoutFirstSeller}</div></div>
                <div class="metric-card ${h2.diffPct > 0 ? 'success' : 'danger'}"><div class="metric-value">${h2.diffPct > 0 ? '+' : ''}${h2.diffPct.toFixed(1)}%</div><div class="metric-label">GMV vs Base Geral</div></div>
                <div class="metric-card success"><div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div><div class="metric-label">Taxa de Upgrade</div><div class="metric-delta positive">${h3.transitions.upgrade} lojas</div></div>
            `;

            document.getElementById('overview-charts').innerHTML = `
                <div class="chart-card"><div id="overview-chart1"></div></div>
                <div class="chart-card"><div id="overview-chart2"></div></div>
            `;

            if (h1.byMonth.length > 0) {
                createChart('overview-chart1', [{
                    x: h1.byMonth.map(m => m.month),
                    y: h1.byMonth.map(m => m.conversionRate),
                    type: 'bar',
                    marker: { color: CHART_COLORS.primary },
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'),
                    textposition: 'outside'
                }], { title: { text: 'Taxa de Convers√£o First Seller por M√™s (%)', font: { size: 14 } }, yaxis: { title: 'Taxa (%)', ticksuffix: '%' } });
            }

            createChart('overview-chart2', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie', hole: 0.45,
                marker: { colors: [CHART_COLORS.success, CHART_COLORS.warning, CHART_COLORS.danger] },
                textinfo: 'label+percent'
            }], { title: { text: 'Evolu√ß√£o de Status', font: { size: 14 } }, showlegend: false });
        }

        function renderH1() {
            const h1 = analysisResults.h1;

            document.getElementById('h1-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${h1.total.toLocaleString()}</div><div class="metric-label">Total Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${h1.fieldEmpty.toLocaleString()}</div><div class="metric-label">Campo Vazio</div><div class="metric-delta">Nunca tiveram FS</div></div>
                <div class="metric-card warning"><div class="metric-value">${h1.withoutFirstSeller.toLocaleString()}</div><div class="metric-label">Denominador</div><div class="metric-delta">Vazio + FS Ap√≥s</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.afterWebinar.toLocaleString()}</div><div class="metric-label">FS Ap√≥s Webinar</div><div class="metric-delta">Numerador</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.overallRate.toFixed(1)}%</div><div class="metric-label">Taxa de Convers√£o</div></div>
            `;

            document.getElementById('h1-charts').innerHTML = `
                <div class="chart-card"><div id="h1-chart1"></div></div>
                <div class="chart-card"><div id="h1-chart2"></div></div>
            `;

            if (h1.byMonth.length > 0) {
                // Gr√°fico de taxa de convers√£o em %
                createChart('h1-chart1', [{
                    x: h1.byMonth.map(m => m.month),
                    y: h1.byMonth.map(m => m.conversionRate),
                    type: 'scatter',
                    mode: 'lines+markers+text',
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'),
                    textposition: 'top center',
                    line: { color: CHART_COLORS.primary, width: 3 },
                    marker: { size: 10 }
                }], { title: { text: 'Taxa de Convers√£o por M√™s (%)', font: { size: 14 } }, yaxis: { title: 'Taxa (%)', ticksuffix: '%' } });

                // Gr√°fico de composi√ß√£o do denominador (stacked bar)
                createChart('h1-chart2', [
                    { x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.fieldEmpty), type: 'bar', name: 'Campo Vazio (n√£o converteram)', marker: { color: CHART_COLORS.secondary } },
                    { x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.afterWebinar), type: 'bar', name: 'FS Ap√≥s Webinar (converteram)', marker: { color: CHART_COLORS.success } }
                ], { title: { text: 'Composi√ß√£o do Denominador', font: { size: 14 } }, barmode: 'stack', yaxis: { title: 'Lojas' } });
            }

            let tableHTML = `
                <div class="chart-card">
                    <h3 class="chart-title">üìã Dados por M√™s</h3>
                    <div class="alert alert-info" style="margin-bottom: var(--space-4);">
                        <p><strong>C√°lculo:</strong> Taxa = (FS Ap√≥s Webinar) / (Campo Vazio + FS Ap√≥s Webinar)</p>
                    </div>
                    <div class="table-container"><table class="data-table">
                        <thead><tr>
                            <th>M√™s</th>
                            <th>Total</th>
                            <th>Campo Vazio</th>
                            <th>FS Ap√≥s Webinar (Num.)</th>
                            <th>Sem FS (Denom.)</th>
                            <th>Taxa Convers√£o</th>
                        </tr></thead>
                        <tbody>`;
            h1.byMonth.forEach(m => {
                tableHTML += `<tr>
                    <td>${m.fullMonth}</td>
                    <td>${m.total.toLocaleString()}</td>
                    <td>${m.fieldEmpty.toLocaleString()}</td>
                    <td style="color: var(--success-interactive);"><strong>${m.afterWebinar.toLocaleString()}</strong></td>
                    <td><strong>${m.withoutFirstSeller.toLocaleString()}</strong></td>
                    <td><strong style="color: var(--success-interactive);">${m.conversionRate.toFixed(2)}%</strong></td>
                </tr>`;
            });
            
            // Linha de totais
            tableHTML += `<tr style="background: var(--neutral-surface); font-weight: bold;">
                <td>TOTAL</td>
                <td>${h1.total.toLocaleString()}</td>
                <td>${h1.fieldEmpty.toLocaleString()}</td>
                <td style="color: var(--success-interactive);">${h1.afterWebinar.toLocaleString()}</td>
                <td>${h1.withoutFirstSeller.toLocaleString()}</td>
                <td style="color: var(--success-interactive);">${h1.overallRate.toFixed(2)}%</td>
            </tr>`;
            
            tableHTML += '</tbody></table></div></div>';
            document.getElementById('h1-table').innerHTML = tableHTML;
        }

        function renderH2() {
            const h2 = analysisResults.h2;

            const summaryClass = h2.diffPct > 0 ? 'alert-success' : 'alert-warning';
            document.getElementById('h2-summary').innerHTML = `
                <div class="alert ${summaryClass}">
                    <p><strong>Participantes vs Base Geral:</strong> GMV m√©dio ${h2.diffPct > 0 ? 'maior' : 'menor'} em ${Math.abs(h2.diffPct).toFixed(1)}%. 
                    ${h2.aboveAvgPct.toFixed(1)}% dos participantes t√™m GMV acima da m√©dia do seu status.</p>
                </div>
            `;

            document.getElementById('h2-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">R$ ${formatNumber(h2.participants.mean)}</div><div class="metric-label">GMV M√©dio Participantes</div></div>
                <div class="metric-card"><div class="metric-value">R$ ${formatNumber(h2.allStores.mean)}</div><div class="metric-label">GMV M√©dio Base Geral</div></div>
                <div class="metric-card ${h2.diffPct > 0 ? 'success' : 'danger'}"><div class="metric-value">${h2.diffPct > 0 ? '+' : ''}${h2.diffPct.toFixed(1)}%</div><div class="metric-label">Diferen√ßa</div></div>
                <div class="metric-card success"><div class="metric-value">${h2.aboveAvgPct.toFixed(1)}%</div><div class="metric-label">Acima da M√©dia do Status</div></div>
            `;

            document.getElementById('h2-charts').innerHTML = `
                <div class="chart-card"><div id="h2-chart1"></div></div>
                <div class="chart-card"><div id="h2-chart2"></div></div>
                <div class="chart-card full-width"><div id="h2-chart3"></div></div>
            `;

            createChart('h2-chart1', [{
                x: ['Participantes', 'Base Geral', 'Controle'],
                y: [h2.participants.mean, h2.allStores.mean, h2.control.mean],
                type: 'bar',
                marker: { color: [CHART_COLORS.primary, CHART_COLORS.secondary, CHART_COLORS.neutral] },
                text: ['R$ ' + formatNumber(h2.participants.mean), 'R$ ' + formatNumber(h2.allStores.mean), 'R$ ' + formatNumber(h2.control.mean)],
                textposition: 'outside'
            }], { title: { text: 'GMV M√©dio (D-30)', font: { size: 14 } }, yaxis: { title: 'GMV (R$)' } });

            const statusData = STATUS_LIST.filter(s => h2.byStatus[s].participants.count > 5);
            createChart('h2-chart2', [
                { x: statusData.map(s => STATUS_LABELS[s]), y: statusData.map(s => h2.byStatus[s].participants.mean), type: 'bar', name: 'Participantes', marker: { color: CHART_COLORS.primary } },
                { x: statusData.map(s => STATUS_LABELS[s]), y: statusData.map(s => h2.byStatus[s].allStores.mean), type: 'bar', name: 'Base Geral', marker: { color: CHART_COLORS.secondary } }
            ], { title: { text: 'GMV M√©dio por Status', font: { size: 14 } }, barmode: 'group' });

            createChart('h2-chart3', [{
                x: statusData.map(s => STATUS_LABELS[s]),
                y: statusData.map(s => h2.byStatus[s].diffPct),
                type: 'bar',
                marker: { color: statusData.map(s => h2.byStatus[s].diffPct > 0 ? CHART_COLORS.success : CHART_COLORS.danger) },
                text: statusData.map(s => (h2.byStatus[s].diffPct > 0 ? '+' : '') + h2.byStatus[s].diffPct.toFixed(1) + '%'),
                textposition: 'outside'
            }], { title: { text: 'Diferen√ßa GMV Participantes vs Base Geral (%)', font: { size: 14 } }, yaxis: { title: 'Diferen√ßa (%)', ticksuffix: '%' } });
        }

        function renderH3() {
            const h3 = analysisResults.h3;

            document.getElementById('h3-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${h3.total.toLocaleString()}</div><div class="metric-label">Lojas Analisadas</div></div>
                <div class="metric-card success"><div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div><div class="metric-label">Taxa de Upgrade</div><div class="metric-delta positive">${h3.transitions.upgrade} lojas</div></div>
                <div class="metric-card warning"><div class="metric-value">${h3.maintainedRate.toFixed(1)}%</div><div class="metric-label">Mantiveram</div><div class="metric-delta">${h3.transitions.maintained} lojas</div></div>
                <div class="metric-card danger"><div class="metric-value">${h3.downgradeRate.toFixed(1)}%</div><div class="metric-label">Downgrade</div><div class="metric-delta negative">${h3.transitions.downgrade} lojas</div></div>
            `;

            document.getElementById('h3-charts').innerHTML = `
                <div class="chart-card"><div id="h3-chart1"></div></div>
                <div class="chart-card"><div id="h3-chart2"></div></div>
            `;

            createChart('h3-chart1', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie', hole: 0.45,
                marker: { colors: [CHART_COLORS.success, CHART_COLORS.warning, CHART_COLORS.danger] }
            }], { title: { text: 'Evolu√ß√£o de Status', font: { size: 14 } }, showlegend: false });

            const pTotal = Object.values(h3.participantsDist).reduce((a, b) => a + b, 0);
            const cTotal = Object.values(h3.controlDist).reduce((a, b) => a + b, 0);
            const pPct = STATUS_LIST.map(s => pTotal > 0 ? (h3.participantsDist[s] / pTotal * 100) : 0);
            const cPct = STATUS_LIST.map(s => cTotal > 0 ? (h3.controlDist[s] / cTotal * 100) : 0);

            createChart('h3-chart2', [
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: pPct, type: 'bar', name: 'Participantes', marker: { color: CHART_COLORS.primary } },
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: cPct, type: 'bar', name: 'Controle', marker: { color: CHART_COLORS.secondary } }
            ], { title: { text: 'Distribui√ß√£o de Status Atual (%)', font: { size: 14 } }, barmode: 'group', yaxis: { title: '%', ticksuffix: '%' } });

            const matrixValues = STATUS_LIST.map(from => STATUS_LIST.map(to => h3.transitionMatrix[from][to]));
            document.getElementById('h3-matrix').innerHTML = '<div class="chart-card full-width"><div id="h3-heatmap"></div></div>';
            createChart('h3-heatmap', [{
                z: matrixValues, x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: STATUS_LIST.map(s => STATUS_LABELS[s]),
                type: 'heatmap', colorscale: [[0, '#F7F7F8'], [0.5, '#E6F0FF'], [1, '#0066E5']],
                text: matrixValues.map(row => row.map(v => v > 0 ? v : '')), texttemplate: '%{text}'
            }], { title: { text: 'Matriz de Transi√ß√£o (De ‚Üí Para)', font: { size: 14 } }, xaxis: { title: 'Status Atual' }, yaxis: { title: 'Status no Webinar', autorange: 'reversed' }, height: 450 });

            let detailsHTML = '<div class="charts-grid three-col">';
            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (data.total >= 10) detailsHTML += `<div class="chart-card"><div id="h3-detail-${status}"></div></div>`;
            });
            detailsHTML += '</div>';
            document.getElementById('h3-details').innerHTML = detailsHTML;

            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (data.total < 10) return;
                const destinations = STATUS_LIST.map(dest => ({ dest, count: data.destinations[dest], label: STATUS_LABELS[dest], pct: data.total > 0 ? (data.destinations[dest] / data.total * 100) : 0 })).filter(d => d.count > 0);
                createChart(`h3-detail-${status}`, [{
                    x: destinations.map(d => d.label), y: destinations.map(d => d.pct), type: 'bar',
                    marker: { color: destinations.map(d => { const from = STATUS_ORDER[status], to = STATUS_ORDER[d.dest]; return to > from ? CHART_COLORS.success : to < from ? CHART_COLORS.danger : CHART_COLORS.warning; }) },
                    text: destinations.map(d => d.pct.toFixed(1) + '%'), textposition: 'outside'
                }], { title: { text: `De ${STATUS_LABELS[status]} (${data.total}) ‚Üí Para:`, font: { size: 13 } }, yaxis: { title: '%', ticksuffix: '%' } });
            });
        }

        function renderProfile() {
            const profile = analysisResults.profile;
            const avgAge = profile.ageStats.mean;
            const avgTimeToSeller = profile.timeToFirstSellerStats.mean;

            document.getElementById('profile-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${profile.totalParticipants.toLocaleString()}</div><div class="metric-label">Lojas Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${Math.round(avgAge)} dias</div><div class="metric-label">Idade M√©dia</div><div class="metric-delta">${(avgAge / 365).toFixed(1)} anos</div></div>
                <div class="metric-card"><div class="metric-value">${Math.round(avgTimeToSeller)} dias</div><div class="metric-label">Tempo at√© First Seller</div><div class="metric-delta">${(avgTimeToSeller / 30).toFixed(1)} meses</div></div>
                <div class="metric-card success"><div class="metric-value">${profile.timeToFirstSeller.length.toLocaleString()}</div><div class="metric-label">Lojas com First Seller</div></div>
            `;

            document.getElementById('profile-charts').innerHTML = `
                <div class="chart-card"><div id="profile-chart1"></div></div>
                <div class="chart-card"><div id="profile-chart2"></div></div>
                <div class="chart-card"><div id="profile-chart3"></div></div>
                <div class="chart-card"><div id="profile-chart4"></div></div>
                <div class="chart-card"><div id="profile-chart5"></div></div>
                <div class="chart-card"><div id="profile-chart6"></div></div>
            `;

            // Gr√°ficos em %
            const totalAge = Object.values(profile.ageCategories).reduce((a, b) => a + b, 0);
            const agePct = Object.entries(profile.ageCategories).map(([k, v]) => ({ label: k, pct: totalAge > 0 ? (v / totalAge * 100) : 0 }));
            createChart('profile-chart1', [{
                x: agePct.map(a => a.label), y: agePct.map(a => a.pct), type: 'bar',
                marker: { color: CHART_COLORS.primary },
                text: agePct.map(a => a.pct.toFixed(1) + '%'), textposition: 'outside'
            }], { title: { text: 'Distribui√ß√£o por Idade da Loja (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });

            const totalTime = Object.values(profile.timeCategories).reduce((a, b) => a + b, 0);
            const timePct = Object.entries(profile.timeCategories).map(([k, v]) => ({ label: k, pct: totalTime > 0 ? (v / totalTime * 100) : 0 }));
            createChart('profile-chart2', [{
                x: timePct.map(t => t.label), y: timePct.map(t => t.pct), type: 'bar',
                marker: { color: CHART_COLORS.success },
                text: timePct.map(t => t.pct.toFixed(1) + '%'), textposition: 'outside'
            }], { title: { text: 'Tempo at√© First Seller (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });

            const statusLabels = Object.keys(profile.statusAtWebinar).filter(s => profile.statusAtWebinar[s] > 0);
            createChart('profile-chart3', [{
                labels: statusLabels.map(s => STATUS_LABELS[s] || s),
                values: statusLabels.map(s => profile.statusAtWebinar[s]),
                type: 'pie', marker: { colors: statusLabels.map(s => STATUS_COLORS[s] || CHART_COLORS.secondary) }
            }], { title: { text: 'Status no Momento do Webinar', font: { size: 14 } } });

            const partLabels = Object.keys(profile.participationType).filter(p => profile.participationType[p] > 0);
            createChart('profile-chart4', [{
                labels: partLabels.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                values: partLabels.map(p => profile.participationType[p]),
                type: 'pie', marker: { colors: [CHART_COLORS.primary, '#8B5CF6', '#A78BFA', '#C4B5FD'] }
            }], { title: { text: 'Tipo de Participa√ß√£o', font: { size: 14 } } });

            if (profile.avgWebinarsByMonth.length > 0) {
                createChart('profile-chart5', [{
                    x: profile.avgWebinarsByMonth.map(m => m.month),
                    y: profile.avgWebinarsByMonth.map(m => m.avgWebinars),
                    type: 'bar', marker: { color: CHART_COLORS.primary },
                    text: profile.avgWebinarsByMonth.map(m => m.avgWebinars.toFixed(2)), textposition: 'outside'
                }], { title: { text: 'M√©dia de Webinars por Loja (por M√™s)', font: { size: 14 } }, yaxis: { title: 'M√©dia' } });
            }

            if (profile.topWebinars.length > 0) {
                createChart('profile-chart6', [{
                    y: profile.topWebinars.map(w => w[0].substring(0, 35) + '...'),
                    x: profile.topWebinars.map(w => w[1]),
                    type: 'bar', orientation: 'h', marker: { color: CHART_COLORS.primary },
                    text: profile.topWebinars.map(w => w[1]), textposition: 'outside'
                }], { title: { text: 'Top 10 Webinars', font: { size: 14 } }, margin: { l: 200, r: 40, t: 50, b: 50 } });
            }

            const avgWebinarsTotal = profile.avgWebinarsByMonth.length > 0 
                ? (profile.avgWebinarsByMonth.reduce((a, b) => a + b.avgWebinars, 0) / profile.avgWebinarsByMonth.length).toFixed(2)
                : '0';

            document.getElementById('profile-insights').innerHTML = `
                <div class="summary-box">
                    <h4>üìã Insights do Perfil</h4>
                    <p>
                        <strong>Idade das lojas:</strong> M√©dia de ${Math.round(avgAge)} dias (${(avgAge/365).toFixed(1)} anos).<br><br>
                        <strong>Tempo at√© First Seller:</strong> M√©dia de ${Math.round(avgTimeToSeller)} dias (${(avgTimeToSeller/30).toFixed(1)} meses). 
                        ${profile.timeCategories['0-30 dias']} lojas (${(profile.timeCategories['0-30 dias'] / totalTime * 100).toFixed(1)}%) converteram em at√© 30 dias.<br><br>
                        <strong>Engajamento m√©dio:</strong> ${avgWebinarsTotal} webinars por loja em m√©dia por m√™s.<br><br>
                        <strong>Retorno:</strong> ${((profile.webinarCountDist['1'] || 0) / profile.totalParticipants * 100).toFixed(1)}% participou de apenas 1 webinar, 
                        ${((profile.webinarCountDist['5+'] || 0) / profile.totalParticipants * 100).toFixed(1)}% participou de 5+.
                    </p>
                </div>
            `;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toFixed(2);
        }
    </script>
</body>
</html>
