<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinar Impact Analyzer - Nuvemshop</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--gray-500);
            font-size: 1.1rem;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .upload-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px dashed var(--gray-300);
            transition: all 0.3s ease;
        }

        .upload-card:hover {
            border-color: var(--primary);
        }

        .upload-card.loaded {
            border-color: var(--success);
            border-style: solid;
        }

        .upload-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        .upload-card input[type="file"] {
            display: none;
        }

        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            cursor: pointer;
            border-radius: 12px;
            background: var(--gray-50);
            transition: background 0.3s ease;
        }

        .upload-label:hover {
            background: var(--gray-100);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: var(--gray-500);
            text-align: center;
        }

        .file-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .analyze-btn {
            display: block;
            width: 100%;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 2rem;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--gray-500);
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: var(--gray-100);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .metric-delta {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .metric-delta.positive {
            color: var(--success);
        }

        .metric-delta.negative {
            color: var(--danger);
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .instructions {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .instructions h2 {
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .instructions table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .instructions th, .instructions td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .instructions th {
            background: var(--gray-50);
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table th {
            background: var(--gray-50);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .summary-box {
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-top: 1rem;
        }

        .summary-box h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .summary-box p {
            color: var(--gray-600);
            line-height: 1.6;
        }

        .info-card {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1.5rem;
        }

        .info-card p {
            color: var(--gray-700);
            margin: 0;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.75rem;
            }

            .tab {
                min-width: 80px;
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Webinar Impact Analyzer</h1>
            <p class="subtitle">An√°lise de impacto dos webinars nas m√©tricas de neg√≥cio | Nuvemshop</p>
        </header>

        <div class="upload-section">
            <div class="upload-card" id="webinar-card">
                <h3>üìã 1. Base de Participantes do Webinar</h3>
                <label class="upload-label" for="webinar-file">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Clique para selecionar o arquivo CSV<br>ou arraste e solte aqui</span>
                </label>
                <input type="file" id="webinar-file" accept=".csv,.txt" onchange="handleWebinarFile(this)">
                <div class="file-info" id="webinar-info" style="display: none;"></div>
            </div>

            <div class="upload-card" id="store-card">
                <h3>üè™ 2. Base Total de Lojas</h3>
                <label class="upload-label" for="store-file">
                    <span class="upload-icon">üìÅ</span>
                    <span class="upload-text">Clique para selecionar o arquivo CSV<br>ou arraste e solte aqui</span>
                </label>
                <input type="file" id="store-file" accept=".csv,.txt" onchange="handleStoreFile(this)">
                <div class="file-info" id="store-info" style="display: none;"></div>
            </div>
        </div>

        <button class="analyze-btn" id="analyze-btn" disabled onclick="runAnalysis()">
            üöÄ Analisar Impacto dos Webinars
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processando dados...</p>
        </div>

        <div class="instructions" id="instructions">
            <h2>üëã Bem-vindo ao Webinar Impact Analyzer!</h2>
            <p>Esta ferramenta analisa o impacto dos webinars em tr√™s hip√≥teses + perfil dos participantes:</p>
            
            <table>
                <thead>
                    <tr>
                        <th>An√°lise</th>
                        <th>M√©tricas</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>H1: First Seller</strong></td>
                        <td>Taxa de convers√£o para primeira venda por m√™s</td>
                    </tr>
                    <tr>
                        <td><strong>H2: GMV</strong></td>
                        <td>Compara√ß√£o de GMV atual entre grupos</td>
                    </tr>
                    <tr>
                        <td><strong>H3: Status</strong></td>
                        <td>Matriz de transi√ß√£o de status detalhada</td>
                    </tr>
                    <tr>
                        <td><strong>Perfil</strong></td>
                        <td>Idade, tempo at√© first seller, distribui√ß√µes</td>
                    </tr>
                </tbody>
            </table>

            <p><strong>Fa√ßa upload dos dois arquivos CSV para come√ßar a an√°lise.</strong></p>
        </div>

        <div class="results-section" id="results">
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">üìà Vis√£o Geral</button>
                <button class="tab" onclick="showTab('h1')">üéØ First Seller</button>
                <button class="tab" onclick="showTab('h2')">üí∞ GMV</button>
                <button class="tab" onclick="showTab('h3')">üìä Status</button>
                <button class="tab" onclick="showTab('profile')">üë§ Perfil</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <div class="metrics-grid" id="overview-metrics"></div>
                <div class="charts-grid" id="overview-charts"></div>
            </div>

            <!-- H1 Tab -->
            <div class="tab-content" id="tab-h1">
                <h2 style="margin-bottom: 1rem;">Hip√≥tese 1: Convers√£o para First Seller</h2>
                <div class="info-card">
                    <p>üìä <strong>Taxa de convers√£o por m√™s:</strong> Use estes dados para comparar com sua base hist√≥rica de convers√£o.</p>
                </div>
                <div class="metrics-grid" id="h1-metrics"></div>
                <div class="charts-grid" id="h1-charts"></div>
                <div id="h1-table"></div>
            </div>

            <!-- H2 Tab -->
            <div class="tab-content" id="tab-h2">
                <h2 style="margin-bottom: 1rem;">Hip√≥tese 2: Impacto no GMV</h2>
                <p style="color: var(--gray-500); margin-bottom: 1.5rem;">
                    Compara√ß√£o de GMV atual entre participantes e grupo de controle
                </p>
                <div id="h2-significance"></div>
                <div class="metrics-grid" id="h2-metrics"></div>
                <div class="charts-grid" id="h2-charts"></div>
            </div>

            <!-- H3 Tab -->
            <div class="tab-content" id="tab-h3">
                <h2 style="margin-bottom: 1rem;">Hip√≥tese 3: Evolu√ß√£o de Status</h2>
                <p style="color: var(--gray-500); margin-bottom: 1.5rem;">
                    An√°lise detalhada de transi√ß√£o de status: de onde vieram e para onde foram
                </p>
                <div class="metrics-grid" id="h3-metrics"></div>
                <div class="charts-grid" id="h3-charts"></div>
                <h3 class="section-title">Matriz de Transi√ß√£o Detalhada</h3>
                <div id="h3-matrix"></div>
                <h3 class="section-title">Transi√ß√µes por Status Inicial</h3>
                <div id="h3-details"></div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="tab-profile">
                <h2 style="margin-bottom: 1rem;">üë§ Perfil dos Participantes</h2>
                <p style="color: var(--gray-500); margin-bottom: 1.5rem;">
                    Insights sobre quem s√£o os participantes dos webinars
                </p>
                <div class="metrics-grid" id="profile-metrics"></div>
                <div class="charts-grid" id="profile-charts"></div>
                <div id="profile-insights"></div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let webinarData = null;
        let storeData = null;
        let analysisResults = null;

        // Status order for comparisons
        const STATUS_ORDER = {
            '': -1,
            'no-seller': 0,
            'struggling-seller': 1,
            'tiny-seller': 2,
            'small-seller': 3,
            'medium-seller': 4,
            'large-seller': 5,
            'top-seller': 6
        };

        const STATUS_LIST = ['no-seller', 'struggling-seller', 'tiny-seller', 'small-seller', 'medium-seller', 'large-seller', 'top-seller'];

        const STATUS_LABELS = {
            'no-seller': 'No Seller',
            'struggling-seller': 'Struggling',
            'tiny-seller': 'Tiny',
            'small-seller': 'Small',
            'medium-seller': 'Medium',
            'large-seller': 'Large',
            'top-seller': 'Top'
        };

        const COLORS = {
            participants: '#6366f1',
            control: '#94a3b8',
            upgrade: '#10b981',
            downgrade: '#ef4444',
            maintained: '#f59e0b'
        };

        const STATUS_COLORS = {
            'no-seller': '#ef4444',
            'struggling-seller': '#f97316',
            'tiny-seller': '#f59e0b',
            'small-seller': '#84cc16',
            'medium-seller': '#22c55e',
            'large-seller': '#14b8a6',
            'top-seller': '#6366f1'
        };

        // Parse date in DD/MM/YYYY format
        function parseDate(dateStr) {
            if (!dateStr || dateStr === '') return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        // File handlers
        function handleWebinarFile(input) {
            const file = input.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                delimiter: '\t',
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data[0] || !results.data[0].store_id) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results2) {
                                webinarData = results2.data;
                                updateFileInfo('webinar', file.name, webinarData.length);
                            }
                        });
                    } else {
                        webinarData = results.data;
                        updateFileInfo('webinar', file.name, webinarData.length);
                    }
                }
            });
        }

        function handleStoreFile(input) {
            const file = input.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                delimiter: '\t',
                skipEmptyLines: true,
                complete: function(results) {
                    if (!results.data[0] || !results.data[0].store_id) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results2) {
                                storeData = processStoreData(results2.data);
                                updateFileInfo('store', file.name, storeData.length);
                            }
                        });
                    } else {
                        storeData = processStoreData(results.data);
                        updateFileInfo('store', file.name, storeData.length);
                    }
                }
            });
        }

        function processStoreData(data) {
            return data.map(row => {
                const keys = Object.keys(row);
                return {
                    store_id: row.store_id,
                    gmv_d30: parseFloat(row[keys[3]]) || 0,
                    gmv_d90: parseFloat(row[keys[4]]) || 0,
                    current_status: (row[keys[5]] || '').toLowerCase().trim(),
                    store_age_days: parseInt(row[keys[6]]) || 0
                };
            });
        }

        function updateFileInfo(type, filename, rows) {
            const card = document.getElementById(`${type}-card`);
            const info = document.getElementById(`${type}-info`);
            
            card.classList.add('loaded');
            info.style.display = 'block';
            info.innerHTML = `‚úÖ <strong>${filename}</strong><br>${rows.toLocaleString()} registros carregados`;
            
            checkReadyToAnalyze();
        }

        function checkReadyToAnalyze() {
            const btn = document.getElementById('analyze-btn');
            btn.disabled = !(webinarData && storeData);
        }

        // Tab handling
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // Analysis functions
        function runAnalysis() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('results').classList.remove('show');

            setTimeout(() => {
                try {
                    analysisResults = performAnalysis();
                    renderResults();
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('results').classList.add('show');
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Erro na an√°lise: ' + error.message);
                    document.getElementById('loading').classList.remove('show');
                }
            }, 100);
        }

        function performAnalysis() {
            // Process webinar data with dates
            const processedWebinar = webinarData.map(row => ({
                ...row,
                store_id: row.store_id,
                webinar_month: row['Data do Webinar (m√™s)'] || '',
                webinar_name: row.webinar_name || '',
                webinar_status: row.webinar_status || '',
                first_seller_at: row.first_seller_at || '',
                first_seller_date: parseDate(row.first_seller_at),
                created_at: row.created_at || '',
                created_date: parseDate(row.created_at),
                status_at_webinar: (row['M√°x. Seller Segment Mes Webinar'] || '').toLowerCase().trim(),
                status_before_webinar: (row['M√°x. Seller Segment Mes-1 Webinar'] || '').toLowerCase().trim()
            }));

            // Create participants summary
            const participantIds = new Set();
            const participantMap = new Map();

            processedWebinar.forEach(row => {
                const storeId = row.store_id;
                if (!storeId) return;
                
                participantIds.add(storeId);
                
                if (!participantMap.has(storeId)) {
                    participantMap.set(storeId, {
                        store_id: storeId,
                        webinar_count: 0,
                        webinars: [],
                        first_seller_at: row.first_seller_at,
                        first_seller_date: row.first_seller_date,
                        created_at: row.created_at,
                        created_date: row.created_date,
                        status_at_webinar: row.status_at_webinar,
                        webinar_month: row.webinar_month,
                        webinar_status: row.webinar_status
                    });
                }
                participantMap.get(storeId).webinar_count++;
                participantMap.get(storeId).webinars.push({
                    month: row.webinar_month,
                    name: row.webinar_name,
                    status: row.webinar_status
                });
            });

            // Merge with store data
            const participants = [];
            const control = [];

            storeData.forEach(store => {
                if (participantMap.has(store.store_id)) {
                    const p = participantMap.get(store.store_id);
                    participants.push({
                        ...store,
                        ...p,
                        status_at_webinar: p.status_at_webinar || '',
                        current_status: store.current_status || ''
                    });
                } else {
                    control.push(store);
                }
            });

            // Run analyses
            const h1 = analyzeFirstSeller(participants, processedWebinar);
            const h2 = analyzeGMV(participants, control);
            const h3 = analyzeStatusEvolution(participants, control);
            const profile = analyzeProfile(participants, processedWebinar);

            return {
                participants,
                control,
                webinarData: processedWebinar,
                h1,
                h2,
                h3,
                profile,
                overview: {
                    participantCount: participants.length,
                    controlCount: control.length,
                    webinarCount: new Set(processedWebinar.map(r => r.webinar_name).filter(n => n)).size,
                    monthCount: new Set(processedWebinar.map(r => r.webinar_month).filter(m => m)).size,
                    totalParticipations: processedWebinar.length
                }
            };
        }

        function analyzeFirstSeller(participants, webinarData) {
            // Group by month and calculate conversion rate
            const byMonth = {};
            const monthOrder = [];
            
            webinarData.forEach(row => {
                const month = row.webinar_month;
                if (!month) return;
                
                if (!byMonth[month]) {
                    byMonth[month] = {
                        month,
                        total: 0,
                        noSellerAtStart: 0,
                        convertedAfter: 0,
                        stores: new Set()
                    };
                    monthOrder.push(month);
                }
                
                // Count unique stores per month
                if (!byMonth[month].stores.has(row.store_id)) {
                    byMonth[month].stores.add(row.store_id);
                    byMonth[month].total++;
                    
                    const wasNoSeller = ['', 'no-seller'].includes(row.status_at_webinar);
                    if (wasNoSeller) {
                        byMonth[month].noSellerAtStart++;
                    }
                    
                    // Check if became seller after webinar
                    if (wasNoSeller && row.first_seller_date) {
                        // Get webinar month as date
                        const webinarMonthMatch = month.match(/(\w+)\s+(\d{4})/);
                        if (webinarMonthMatch) {
                            const monthNames = {
                                'january': 0, 'february': 1, 'march': 2, 'april': 3,
                                'may': 4, 'june': 5, 'july': 6, 'august': 7,
                                'september': 8, 'october': 9, 'november': 10, 'december': 11
                            };
                            const monthName = month.toLowerCase().split(' - ')[1]?.split(' ')[0] || '';
                            const year = parseInt(webinarMonthMatch[2]);
                            const monthNum = monthNames[monthName];
                            
                            if (monthNum !== undefined) {
                                const webinarDate = new Date(year, monthNum, 1);
                                if (row.first_seller_date >= webinarDate) {
                                    byMonth[month].convertedAfter++;
                                }
                            }
                        }
                    }
                }
            });

            // Sort months chronologically
            const sortedMonths = monthOrder.sort((a, b) => {
                const getMonthNum = (m) => {
                    const match = m.match(/Month\s+(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getMonthNum(a) - getMonthNum(b);
            });

            const monthlyData = sortedMonths.map(month => ({
                month: month.replace('Month ', 'M').split(' - ')[0],
                fullMonth: month,
                total: byMonth[month].total,
                noSellerAtStart: byMonth[month].noSellerAtStart,
                converted: byMonth[month].convertedAfter,
                conversionRate: byMonth[month].noSellerAtStart > 0 
                    ? (byMonth[month].convertedAfter / byMonth[month].noSellerAtStart * 100) 
                    : 0
            }));

            // Overall stats
            const totalNoSeller = participants.filter(p => 
                ['', 'no-seller'].includes(p.status_at_webinar)
            ).length;
            
            const totalConverted = participants.filter(p =>
                ['', 'no-seller'].includes(p.status_at_webinar) &&
                !['', 'no-seller'].includes(p.current_status)
            ).length;

            return {
                byMonth: monthlyData,
                total: participants.length,
                noSellerAtStart: totalNoSeller,
                converted: totalConverted,
                overallRate: totalNoSeller > 0 ? (totalConverted / totalNoSeller * 100) : 0
            };
        }

        function analyzeGMV(participants, control) {
            const pGmv30 = participants.map(p => p.gmv_d30).filter(v => !isNaN(v));
            const cGmv30 = control.map(c => c.gmv_d30).filter(v => !isNaN(v));

            const pStats = calculateStats(pGmv30);
            const cStats = calculateStats(cGmv30);

            const tTestResult = tTest(pGmv30, cGmv30);

            const meanDiffPct = cStats.mean > 0 ? 
                ((pStats.mean - cStats.mean) / cStats.mean * 100) : 0;

            // GMV by status
            const gmvByStatus = {};
            STATUS_LIST.forEach(status => {
                const pValues = participants.filter(p => p.current_status === status).map(p => p.gmv_d30);
                const cValues = control.filter(c => c.current_status === status).map(c => c.gmv_d30);
                gmvByStatus[status] = {
                    participants: calculateStats(pValues),
                    control: calculateStats(cValues)
                };
            });

            return {
                participants: pStats,
                control: cStats,
                tTest: tTestResult,
                meanDiffPct,
                byStatus: gmvByStatus
            };
        }

        function analyzeStatusEvolution(participants, control) {
            const transitions = { upgrade: 0, maintained: 0, downgrade: 0, unknown: 0 };
            
            // Detailed transition matrix
            const transitionMatrix = {};
            STATUS_LIST.forEach(from => {
                transitionMatrix[from] = {};
                STATUS_LIST.forEach(to => {
                    transitionMatrix[from][to] = 0;
                });
            });

            // Track transitions by initial status
            const transitionsByInitial = {};
            STATUS_LIST.forEach(status => {
                transitionsByInitial[status] = {
                    total: 0,
                    upgrade: 0,
                    maintained: 0,
                    downgrade: 0,
                    destinations: {}
                };
                STATUS_LIST.forEach(dest => {
                    transitionsByInitial[status].destinations[dest] = 0;
                });
            });

            participants.forEach(p => {
                const before = p.status_at_webinar;
                const after = p.current_status;
                const beforeNum = STATUS_ORDER[before];
                const afterNum = STATUS_ORDER[after];

                if (beforeNum === undefined || afterNum === undefined || beforeNum < 0 || afterNum < 0) {
                    transitions.unknown++;
                    return;
                }

                // Update matrix
                if (transitionMatrix[before]) {
                    transitionMatrix[before][after]++;
                }

                // Update transitions by initial
                if (transitionsByInitial[before]) {
                    transitionsByInitial[before].total++;
                    transitionsByInitial[before].destinations[after]++;
                    
                    if (afterNum > beforeNum) {
                        transitions.upgrade++;
                        transitionsByInitial[before].upgrade++;
                    } else if (afterNum < beforeNum) {
                        transitions.downgrade++;
                        transitionsByInitial[before].downgrade++;
                    } else {
                        transitions.maintained++;
                        transitionsByInitial[before].maintained++;
                    }
                }
            });

            const total = transitions.upgrade + transitions.maintained + transitions.downgrade;

            // Status distribution comparison
            const pDist = {};
            const cDist = {};
            
            STATUS_LIST.forEach(s => {
                pDist[s] = participants.filter(p => p.current_status === s).length;
                cDist[s] = control.filter(c => c.current_status === s).length;
            });

            return {
                transitions,
                total,
                upgradeRate: total > 0 ? (transitions.upgrade / total * 100) : 0,
                maintainedRate: total > 0 ? (transitions.maintained / total * 100) : 0,
                downgradeRate: total > 0 ? (transitions.downgrade / total * 100) : 0,
                transitionMatrix,
                transitionsByInitial,
                participantsDist: pDist,
                controlDist: cDist
            };
        }

        function analyzeProfile(participants, webinarData) {
            // Age distribution
            const ages = participants.map(p => p.store_age_days).filter(a => a > 0);
            const ageCategories = {
                '0-30 dias': 0,
                '31-90 dias': 0,
                '91-180 dias': 0,
                '181-365 dias': 0,
                '1-2 anos': 0,
                '2+ anos': 0
            };
            
            ages.forEach(age => {
                if (age <= 30) ageCategories['0-30 dias']++;
                else if (age <= 90) ageCategories['31-90 dias']++;
                else if (age <= 180) ageCategories['91-180 dias']++;
                else if (age <= 365) ageCategories['181-365 dias']++;
                else if (age <= 730) ageCategories['1-2 anos']++;
                else ageCategories['2+ anos']++;
            });

            // Time to first seller (from store creation)
            const timeToFirstSeller = [];
            participants.forEach(p => {
                if (p.created_date && p.first_seller_date && p.first_seller_date > p.created_date) {
                    const days = Math.floor((p.first_seller_date - p.created_date) / (1000 * 60 * 60 * 24));
                    if (days >= 0 && days < 3650) { // Limit to 10 years
                        timeToFirstSeller.push(days);
                    }
                }
            });

            // Status distribution at webinar
            const statusAtWebinar = {};
            STATUS_LIST.forEach(s => {
                statusAtWebinar[s] = participants.filter(p => p.status_at_webinar === s).length;
            });
            statusAtWebinar['sem status'] = participants.filter(p => !p.status_at_webinar || p.status_at_webinar === '').length;

            // Webinar participation type
            const participationType = {
                'live': 0,
                'on-demand': 0,
                'registered': 0,
                'outro': 0
            };
            webinarData.forEach(row => {
                const status = (row.webinar_status || '').toLowerCase();
                if (participationType[status] !== undefined) {
                    participationType[status]++;
                } else {
                    participationType['outro']++;
                }
            });

            // Webinar count distribution
            const webinarCountDist = {};
            participants.forEach(p => {
                const count = p.webinar_count || 1;
                const key = count >= 5 ? '5+' : count.toString();
                webinarCountDist[key] = (webinarCountDist[key] || 0) + 1;
            });

            // Top webinars
            const webinarCounts = {};
            webinarData.forEach(row => {
                const name = row.webinar_name;
                if (name) {
                    webinarCounts[name] = (webinarCounts[name] || 0) + 1;
                }
            });
            const topWebinars = Object.entries(webinarCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            return {
                ageCategories,
                ageStats: calculateStats(ages),
                timeToFirstSeller,
                timeToFirstSellerStats: calculateStats(timeToFirstSeller),
                statusAtWebinar,
                participationType,
                webinarCountDist,
                topWebinars,
                totalParticipants: participants.length,
                uniqueStores: new Set(participants.map(p => p.store_id)).size
            };
        }

        // Statistical functions
        function calculateStats(arr) {
            if (!arr || arr.length === 0) return { mean: 0, median: 0, std: 0, count: 0 };
            
            const sorted = [...arr].sort((a, b) => a - b);
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const median = sorted[Math.floor(sorted.length / 2)];
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / arr.length;
            const std = Math.sqrt(variance);

            return { mean, median, std, count: arr.length };
        }

        function tTest(arr1, arr2) {
            if (!arr1 || !arr2 || arr1.length < 2 || arr2.length < 2) {
                return { statistic: 0, pValue: 1, significant: false };
            }

            const stats1 = calculateStats(arr1);
            const stats2 = calculateStats(arr2);

            const se = Math.sqrt((stats1.std * stats1.std / stats1.count) + 
                                 (stats2.std * stats2.std / stats2.count));
            
            if (se === 0) return { statistic: 0, pValue: 1, significant: false };

            const t = (stats1.mean - stats2.mean) / se;
            const df = Math.min(stats1.count, stats2.count) - 1;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(t)));

            return {
                statistic: t,
                pValue,
                significant: pValue < 0.05
            };
        }

        function normalCDF(x) {
            const a1 =  0.254829592;
            const a2 = -0.284496736;
            const a3 =  1.421413741;
            const a4 = -1.453152027;
            const a5 =  1.061405429;
            const p  =  0.3275911;

            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);

            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);

            return 0.5 * (1.0 + sign * y);
        }

        // Rendering functions
        function renderResults() {
            renderOverview();
            renderH1();
            renderH2();
            renderH3();
            renderProfile();
        }

        function renderOverview() {
            const o = analysisResults.overview;
            const h1 = analysisResults.h1;
            const h2 = analysisResults.h2;
            const h3 = analysisResults.h3;

            document.getElementById('overview-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${o.participantCount.toLocaleString()}</div>
                    <div class="metric-label">Lojas Participantes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${o.controlCount.toLocaleString()}</div>
                    <div class="metric-label">Grupo de Controle</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${o.totalParticipations.toLocaleString()}</div>
                    <div class="metric-label">Total Participa√ß√µes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${o.webinarCount}</div>
                    <div class="metric-label">Webinars</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h1.overallRate.toFixed(1)}%</div>
                    <div class="metric-label">Convers√£o First Seller</div>
                    <div class="metric-delta">${h1.converted} de ${h1.noSellerAtStart} no-sellers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div>
                    <div class="metric-label">Taxa de Upgrade</div>
                    <div class="metric-delta positive">${h3.transitions.upgrade} lojas subiram</div>
                </div>
            `;

            // Overview charts
            document.getElementById('overview-charts').innerHTML = `
                <div class="chart-container"><div id="overview-chart1"></div></div>
                <div class="chart-container"><div id="overview-chart2"></div></div>
            `;

            // Conversion by month
            if (h1.byMonth.length > 0) {
                Plotly.newPlot('overview-chart1', [{
                    x: h1.byMonth.map(m => m.month),
                    y: h1.byMonth.map(m => m.conversionRate),
                    type: 'bar',
                    marker: { color: COLORS.participants },
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'),
                    textposition: 'outside'
                }], {
                    title: 'Taxa de Convers√£o First Seller por M√™s',
                    yaxis: { title: 'Taxa (%)' },
                    height: 350
                }, { responsive: true });
            }

            // Status evolution pie
            Plotly.newPlot('overview-chart2', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie',
                hole: 0.4,
                marker: { colors: [COLORS.upgrade, COLORS.maintained, COLORS.downgrade] },
                textinfo: 'label+percent'
            }], {
                title: 'Evolu√ß√£o de Status',
                height: 350
            }, { responsive: true });
        }

        function renderH1() {
            const h1 = analysisResults.h1;

            // Metrics
            document.getElementById('h1-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${h1.total.toLocaleString()}</div>
                    <div class="metric-label">Total Participantes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h1.noSellerAtStart.toLocaleString()}</div>
                    <div class="metric-label">No-Sellers no In√≠cio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h1.converted.toLocaleString()}</div>
                    <div class="metric-label">Converteram</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h1.overallRate.toFixed(1)}%</div>
                    <div class="metric-label">Taxa Geral</div>
                </div>
            `;

            // Charts
            document.getElementById('h1-charts').innerHTML = `
                <div class="chart-container"><div id="h1-chart1"></div></div>
                <div class="chart-container"><div id="h1-chart2"></div></div>
            `;

            // Conversion rate by month
            if (h1.byMonth.length > 0) {
                Plotly.newPlot('h1-chart1', [{
                    x: h1.byMonth.map(m => m.month),
                    y: h1.byMonth.map(m => m.conversionRate),
                    type: 'scatter',
                    mode: 'lines+markers+text',
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'),
                    textposition: 'top center',
                    line: { color: COLORS.participants, width: 3 },
                    marker: { size: 10 }
                }], {
                    title: 'Taxa de Convers√£o para First Seller por M√™s',
                    yaxis: { title: 'Taxa de Convers√£o (%)' },
                    xaxis: { title: 'M√™s do Webinar' },
                    height: 400
                }, { responsive: true });

                // Volume by month
                Plotly.newPlot('h1-chart2', [
                    {
                        x: h1.byMonth.map(m => m.month),
                        y: h1.byMonth.map(m => m.noSellerAtStart),
                        type: 'bar',
                        name: 'No-Sellers',
                        marker: { color: COLORS.control }
                    },
                    {
                        x: h1.byMonth.map(m => m.month),
                        y: h1.byMonth.map(m => m.converted),
                        type: 'bar',
                        name: 'Converteram',
                        marker: { color: COLORS.upgrade }
                    }
                ], {
                    title: 'Volume de Convers√£o por M√™s',
                    barmode: 'group',
                    yaxis: { title: 'Quantidade' },
                    height: 400
                }, { responsive: true });
            }

            // Table with monthly data
            let tableHTML = `
                <div class="chart-container">
                    <h3 class="chart-title">üìã Dados por M√™s (para compara√ß√£o com base hist√≥rica)</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>M√™s</th>
                                    <th>Participantes</th>
                                    <th>No-Sellers</th>
                                    <th>Converteram</th>
                                    <th>Taxa Convers√£o</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            h1.byMonth.forEach(m => {
                tableHTML += `
                    <tr>
                        <td>${m.fullMonth}</td>
                        <td>${m.total.toLocaleString()}</td>
                        <td>${m.noSellerAtStart.toLocaleString()}</td>
                        <td>${m.converted.toLocaleString()}</td>
                        <td><strong>${m.conversionRate.toFixed(2)}%</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('h1-table').innerHTML = tableHTML;
        }

        function renderH2() {
            const h2 = analysisResults.h2;

            // Significance badge
            document.getElementById('h2-significance').innerHTML = h2.tTest.significant ?
                `<div class="info-card"><p>‚úÖ <strong>Resultado estatisticamente significativo</strong> (p-valor: ${h2.tTest.pValue.toFixed(4)})</p></div>` :
                `<div class="info-card"><p>‚ö†Ô∏è <strong>Resultado n√£o √© estatisticamente significativo</strong> (p-valor: ${h2.tTest.pValue.toFixed(4)})</p></div>`;

            // Metrics
            document.getElementById('h2-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">R$ ${formatNumber(h2.participants.mean)}</div>
                    <div class="metric-label">GMV M√©dio (Participantes)</div>
                    <div class="metric-delta">Mediana: R$ ${formatNumber(h2.participants.median)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">R$ ${formatNumber(h2.control.mean)}</div>
                    <div class="metric-label">GMV M√©dio (Controle)</div>
                    <div class="metric-delta">Mediana: R$ ${formatNumber(h2.control.median)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${h2.meanDiffPct > 0 ? '+' : ''}${h2.meanDiffPct.toFixed(1)}%</div>
                    <div class="metric-label">Diferen√ßa</div>
                    <div class="metric-delta">Participantes vs Controle</div>
                </div>
            `;

            // Charts
            document.getElementById('h2-charts').innerHTML = `
                <div class="chart-container"><div id="h2-chart1"></div></div>
                <div class="chart-container"><div id="h2-chart2"></div></div>
                <div class="chart-container" style="grid-column: 1 / -1;"><div id="h2-chart3"></div></div>
            `;

            // Bar chart
            Plotly.newPlot('h2-chart1', [{
                x: ['Participantes', 'Controle'],
                y: [h2.participants.mean, h2.control.mean],
                type: 'bar',
                marker: { color: [COLORS.participants, COLORS.control] },
                text: ['R$ ' + formatNumber(h2.participants.mean), 'R$ ' + formatNumber(h2.control.mean)],
                textposition: 'outside'
            }], {
                title: 'Compara√ß√£o de GMV M√©dio (D-30)',
                yaxis: { title: 'GMV (R$)' },
                height: 350
            }, { responsive: true });

            // Box plot
            const pGmv = analysisResults.participants.map(p => p.gmv_d30).filter(v => v > 0 && v < 100000);
            const cGmv = analysisResults.control.map(c => c.gmv_d30).filter(v => v > 0 && v < 100000);

            Plotly.newPlot('h2-chart2', [
                { y: pGmv, type: 'box', name: 'Participantes', marker: { color: COLORS.participants } },
                { y: cGmv, type: 'box', name: 'Controle', marker: { color: COLORS.control } }
            ], {
                title: 'Distribui√ß√£o de GMV (at√© R$ 100k)',
                yaxis: { title: 'GMV (R$)' },
                height: 350
            }, { responsive: true });

            // GMV by status comparison
            const statusData = [];
            STATUS_LIST.forEach(status => {
                if (h2.byStatus[status].participants.count > 10) {
                    statusData.push({
                        status: STATUS_LABELS[status],
                        pMean: h2.byStatus[status].participants.mean,
                        cMean: h2.byStatus[status].control.mean
                    });
                }
            });

            if (statusData.length > 0) {
                Plotly.newPlot('h2-chart3', [
                    {
                        x: statusData.map(s => s.status),
                        y: statusData.map(s => s.pMean),
                        type: 'bar',
                        name: 'Participantes',
                        marker: { color: COLORS.participants }
                    },
                    {
                        x: statusData.map(s => s.status),
                        y: statusData.map(s => s.cMean),
                        type: 'bar',
                        name: 'Controle',
                        marker: { color: COLORS.control }
                    }
                ], {
                    title: 'GMV M√©dio por Status Atual',
                    barmode: 'group',
                    yaxis: { title: 'GMV (R$)' },
                    height: 400
                }, { responsive: true });
            }
        }

        function renderH3() {
            const h3 = analysisResults.h3;

            // Metrics
            document.getElementById('h3-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${h3.total.toLocaleString()}</div>
                    <div class="metric-label">Lojas Analisadas</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid ${COLORS.upgrade}">
                    <div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div>
                    <div class="metric-label">Taxa de Upgrade</div>
                    <div class="metric-delta positive">${h3.transitions.upgrade.toLocaleString()} lojas</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid ${COLORS.maintained}">
                    <div class="metric-value">${h3.maintainedRate.toFixed(1)}%</div>
                    <div class="metric-label">Mantiveram Status</div>
                    <div class="metric-delta">${h3.transitions.maintained.toLocaleString()} lojas</div>
                </div>
                <div class="metric-card" style="border-left: 4px solid ${COLORS.downgrade}">
                    <div class="metric-value">${h3.downgradeRate.toFixed(1)}%</div>
                    <div class="metric-label">Taxa de Downgrade</div>
                    <div class="metric-delta negative">${h3.transitions.downgrade.toLocaleString()} lojas</div>
                </div>
            `;

            // Charts
            document.getElementById('h3-charts').innerHTML = `
                <div class="chart-container"><div id="h3-chart1"></div></div>
                <div class="chart-container"><div id="h3-chart2"></div></div>
            `;

            // Pie chart
            Plotly.newPlot('h3-chart1', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie',
                hole: 0.4,
                marker: { colors: [COLORS.upgrade, COLORS.maintained, COLORS.downgrade] },
                textinfo: 'label+percent'
            }], {
                title: 'Evolu√ß√£o de Status dos Participantes',
                height: 400
            }, { responsive: true });

            // Status distribution comparison
            const pTotal = Object.values(h3.participantsDist).reduce((a, b) => a + b, 0);
            const cTotal = Object.values(h3.controlDist).reduce((a, b) => a + b, 0);

            const pPct = STATUS_LIST.map(s => pTotal > 0 ? (h3.participantsDist[s] / pTotal * 100) : 0);
            const cPct = STATUS_LIST.map(s => cTotal > 0 ? (h3.controlDist[s] / cTotal * 100) : 0);

            Plotly.newPlot('h3-chart2', [
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: pPct, type: 'bar', name: 'Participantes', marker: { color: COLORS.participants } },
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: cPct, type: 'bar', name: 'Controle', marker: { color: COLORS.control } }
            ], {
                title: 'Distribui√ß√£o de Status Atual (%)',
                barmode: 'group',
                yaxis: { title: 'Percentual (%)' },
                height: 400
            }, { responsive: true });

            // Transition matrix heatmap
            const matrixValues = STATUS_LIST.map(from => 
                STATUS_LIST.map(to => h3.transitionMatrix[from][to])
            );

            document.getElementById('h3-matrix').innerHTML = '<div class="chart-container"><div id="h3-heatmap"></div></div>';

            Plotly.newPlot('h3-heatmap', [{
                z: matrixValues,
                x: STATUS_LIST.map(s => STATUS_LABELS[s]),
                y: STATUS_LIST.map(s => STATUS_LABELS[s]),
                type: 'heatmap',
                colorscale: 'Blues',
                text: matrixValues.map(row => row.map(v => v > 0 ? v : '')),
                texttemplate: '%{text}',
                hovertemplate: 'De: %{y}<br>Para: %{x}<br>Quantidade: %{z}<extra></extra>'
            }], {
                title: 'Matriz de Transi√ß√£o de Status (De ‚Üí Para)',
                xaxis: { title: 'Status Atual (Para)', side: 'bottom' },
                yaxis: { title: 'Status no Webinar (De)', autorange: 'reversed' },
                height: 500
            }, { responsive: true });

            // Detailed transitions by initial status
            let detailsHTML = '<div class="charts-grid">';
            
            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (data.total < 10) return;

                const destinations = STATUS_LIST
                    .map(dest => ({ dest, count: data.destinations[dest] }))
                    .filter(d => d.count > 0);

                detailsHTML += `
                    <div class="chart-container">
                        <div id="h3-detail-${status}"></div>
                    </div>
                `;
            });
            
            detailsHTML += '</div>';
            document.getElementById('h3-details').innerHTML = detailsHTML;

            // Render individual charts
            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (data.total < 10) return;

                const destinations = STATUS_LIST
                    .map(dest => ({ dest, count: data.destinations[dest], label: STATUS_LABELS[dest] }))
                    .filter(d => d.count > 0);

                Plotly.newPlot(`h3-detail-${status}`, [{
                    x: destinations.map(d => d.label),
                    y: destinations.map(d => d.count),
                    type: 'bar',
                    marker: { 
                        color: destinations.map(d => {
                            const fromNum = STATUS_ORDER[status];
                            const toNum = STATUS_ORDER[d.dest];
                            if (toNum > fromNum) return COLORS.upgrade;
                            if (toNum < fromNum) return COLORS.downgrade;
                            return COLORS.maintained;
                        })
                    },
                    text: destinations.map(d => d.count),
                    textposition: 'outside'
                }], {
                    title: `De ${STATUS_LABELS[status]} (${data.total} lojas) ‚Üí Para:`,
                    yaxis: { title: 'Quantidade' },
                    height: 300
                }, { responsive: true });
            });
        }

        function renderProfile() {
            const profile = analysisResults.profile;

            // Metrics
            const avgAge = profile.ageStats.mean;
            const avgTimeToSeller = profile.timeToFirstSellerStats.mean;

            document.getElementById('profile-metrics').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${profile.totalParticipants.toLocaleString()}</div>
                    <div class="metric-label">Lojas Participantes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Math.round(avgAge)} dias</div>
                    <div class="metric-label">Idade M√©dia das Lojas</div>
                    <div class="metric-delta">${(avgAge / 365).toFixed(1)} anos</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${Math.round(avgTimeToSeller)} dias</div>
                    <div class="metric-label">Tempo M√©dio at√© First Seller</div>
                    <div class="metric-delta">${(avgTimeToSeller / 30).toFixed(1)} meses</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${profile.timeToFirstSeller.length.toLocaleString()}</div>
                    <div class="metric-label">Lojas com First Seller</div>
                </div>
            `;

            // Charts
            document.getElementById('profile-charts').innerHTML = `
                <div class="chart-container"><div id="profile-chart1"></div></div>
                <div class="chart-container"><div id="profile-chart2"></div></div>
                <div class="chart-container"><div id="profile-chart3"></div></div>
                <div class="chart-container"><div id="profile-chart4"></div></div>
                <div class="chart-container"><div id="profile-chart5"></div></div>
                <div class="chart-container"><div id="profile-chart6"></div></div>
            `;

            // Age distribution
            const ageLabels = Object.keys(profile.ageCategories);
            const ageValues = Object.values(profile.ageCategories);

            Plotly.newPlot('profile-chart1', [{
                x: ageLabels,
                y: ageValues,
                type: 'bar',
                marker: { color: COLORS.participants },
                text: ageValues.map(v => v.toLocaleString()),
                textposition: 'outside'
            }], {
                title: 'Distribui√ß√£o por Idade da Loja',
                yaxis: { title: 'Quantidade' },
                height: 350
            }, { responsive: true });

            // Time to first seller histogram
            if (profile.timeToFirstSeller.length > 0) {
                Plotly.newPlot('profile-chart2', [{
                    x: profile.timeToFirstSeller,
                    type: 'histogram',
                    nbinsx: 30,
                    marker: { color: COLORS.participants }
                }], {
                    title: 'Tempo at√© First Seller (dias)',
                    xaxis: { title: 'Dias' },
                    yaxis: { title: 'Quantidade de Lojas' },
                    height: 350
                }, { responsive: true });
            }

            // Status at webinar
            const statusLabels = Object.keys(profile.statusAtWebinar).filter(s => profile.statusAtWebinar[s] > 0);
            const statusValues = statusLabels.map(s => profile.statusAtWebinar[s]);

            Plotly.newPlot('profile-chart3', [{
                labels: statusLabels.map(s => STATUS_LABELS[s] || s),
                values: statusValues,
                type: 'pie',
                marker: { colors: statusLabels.map(s => STATUS_COLORS[s] || COLORS.control) }
            }], {
                title: 'Status no Momento do Webinar',
                height: 350
            }, { responsive: true });

            // Participation type
            const partLabels = Object.keys(profile.participationType).filter(p => profile.participationType[p] > 0);
            const partValues = partLabels.map(p => profile.participationType[p]);

            Plotly.newPlot('profile-chart4', [{
                labels: partLabels.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                values: partValues,
                type: 'pie',
                marker: { colors: ['#6366f1', '#8b5cf6', '#a78bfa', '#c4b5fd'] }
            }], {
                title: 'Tipo de Participa√ß√£o',
                height: 350
            }, { responsive: true });

            // Webinar count distribution
            const countLabels = ['1', '2', '3', '4', '5+'];
            const countValues = countLabels.map(l => profile.webinarCountDist[l] || 0);

            Plotly.newPlot('profile-chart5', [{
                x: countLabels,
                y: countValues,
                type: 'bar',
                marker: { color: COLORS.secondary },
                text: countValues.map(v => v.toLocaleString()),
                textposition: 'outside'
            }], {
                title: 'Quantidade de Webinars por Loja',
                xaxis: { title: 'Webinars Participados' },
                yaxis: { title: 'Quantidade de Lojas' },
                height: 350
            }, { responsive: true });

            // Top webinars
            if (profile.topWebinars.length > 0) {
                Plotly.newPlot('profile-chart6', [{
                    y: profile.topWebinars.map(w => w[0].substring(0, 40) + '...'),
                    x: profile.topWebinars.map(w => w[1]),
                    type: 'bar',
                    orientation: 'h',
                    marker: { color: COLORS.participants },
                    text: profile.topWebinars.map(w => w[1]),
                    textposition: 'outside'
                }], {
                    title: 'Top 10 Webinars (por Participa√ß√£o)',
                    xaxis: { title: 'Participa√ß√µes' },
                    margin: { l: 250 },
                    height: 400
                }, { responsive: true });
            }

            // Insights
            document.getElementById('profile-insights').innerHTML = `
                <div class="summary-box">
                    <h4>üìã Insights do Perfil</h4>
                    <p>
                        <strong>Idade das lojas:</strong> A m√©dia √© de ${Math.round(avgAge)} dias (${(avgAge/365).toFixed(1)} anos). 
                        A maioria das lojas participantes tem ${Object.entries(profile.ageCategories).sort((a,b) => b[1] - a[1])[0][0]}.<br><br>
                        <strong>Tempo at√© First Seller:</strong> Em m√©dia, lojas que fizeram first seller levaram ${Math.round(avgTimeToSeller)} dias 
                        (${(avgTimeToSeller/30).toFixed(1)} meses) desde a cria√ß√£o.<br><br>
                        <strong>Engajamento:</strong> ${((profile.webinarCountDist['1'] || 0) / profile.totalParticipants * 100).toFixed(1)}% 
                        participou de apenas 1 webinar, enquanto ${((profile.webinarCountDist['5+'] || 0) / profile.totalParticipants * 100).toFixed(1)}% 
                        participou de 5 ou mais.
                    </p>
                </div>
            `;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toFixed(2);
        }
    </script>
</body>
</html>
