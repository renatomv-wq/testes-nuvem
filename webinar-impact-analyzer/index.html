<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webinar Impact Report - Nuvemshop</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-surface: #0050B3;
            --primary-interactive: #0066E5;
            --primary-interactive-hover: #0050B3;
            --primary-text-low: #E6F0FF;
            --neutral-background: #FFFFFF;
            --neutral-surface: #F7F7F8;
            --neutral-surface-highlight: #EBEBED;
            --neutral-interactive: #E1E1E3;
            --neutral-text-low: #8C8C8C;
            --neutral-text-high: #14171A;
            --success-surface: #E6F9ED;
            --success-interactive: #00A650;
            --success-text-low: #006633;
            --warning-surface: #FFF4E6;
            --warning-interactive: #FF9500;
            --warning-text-low: #995900;
            --danger-surface: #FFE6E6;
            --danger-interactive: #E53935;
            --danger-text-low: #B71C1C;
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px;
            --space-5: 20px; --space-6: 24px; --space-8: 32px; --space-10: 40px;
            --radius-1: 4px; --radius-2: 8px; --radius-3: 12px; --radius-full: 9999px;
            --shadow-level-1: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-level-2: 0 4px 12px rgba(0, 0, 0, 0.12);
            --font-family: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background: var(--neutral-surface);
            min-height: 100vh;
            color: var(--neutral-text-high);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Header */
        .app-header {
            background: var(--neutral-background);
            border-bottom: 1px solid var(--neutral-interactive);
            padding: var(--space-4) var(--space-6);
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
        }
        .logo { display: flex; align-items: center; gap: var(--space-2); }
        .logo-icon {
            width: 32px; height: 32px;
            background: var(--primary-interactive);
            border-radius: var(--radius-2);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 18px;
        }
        .logo-text { font-size: 16px; font-weight: 700; }
        .header-badge {
            background: var(--success-surface); color: var(--success-text-low);
            padding: var(--space-1) var(--space-3); border-radius: var(--radius-full);
            font-size: 12px; font-weight: 500;
        }

        /* Home/Chat Section */
        .home-section {
            min-height: calc(100vh - 65px);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: var(--space-6);
            background: linear-gradient(180deg, var(--neutral-background) 0%, var(--neutral-surface) 100%);
        }
        .home-title {
            font-size: 48px; font-weight: 700;
            background: linear-gradient(135deg, var(--primary-interactive) 0%, #8B5CF6 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: var(--space-2);
        }
        .home-subtitle {
            font-size: 18px; color: var(--neutral-text-low);
            margin-bottom: var(--space-8); text-align: center;
        }

        /* Chat Box */
        .chat-container {
            width: 100%; max-width: 700px;
            background: var(--neutral-background);
            border-radius: var(--radius-3);
            box-shadow: var(--shadow-level-2);
            overflow: hidden;
        }
        .chat-input-wrapper {
            display: flex; align-items: center;
            padding: var(--space-4); gap: var(--space-3);
            border-bottom: 1px solid var(--neutral-interactive);
        }
        .chat-input {
            flex: 1; border: none; outline: none;
            font-size: 16px; font-family: var(--font-family);
            background: transparent;
        }
        .chat-input::placeholder { color: var(--neutral-text-low); }
        .chat-send {
            width: 40px; height: 40px;
            background: var(--primary-interactive);
            border: none; border-radius: var(--radius-full);
            color: white; font-size: 18px;
            cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .chat-send:hover { background: var(--primary-interactive-hover); }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

        .chat-messages {
            max-height: 400px; overflow-y: auto;
            padding: var(--space-4);
            display: none;
        }
        .chat-messages.has-messages { display: block; }
        .chat-message {
            margin-bottom: var(--space-4);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message.user {
            display: flex; justify-content: flex-end;
        }
        .chat-message.user .message-content {
            background: var(--primary-interactive);
            color: white; border-radius: var(--radius-2) var(--radius-2) 0 var(--radius-2);
        }
        .chat-message.assistant .message-content {
            background: var(--neutral-surface);
            border-radius: var(--radius-2) var(--radius-2) var(--radius-2) 0;
        }
        .message-content {
            padding: var(--space-3) var(--space-4);
            max-width: 85%; line-height: 1.6;
        }
        .message-content code {
            background: rgba(0,0,0,0.1); padding: 2px 6px;
            border-radius: var(--radius-1); font-size: 13px;
        }
        .typing-indicator {
            display: flex; gap: 4px; padding: var(--space-3) var(--space-4);
            background: var(--neutral-surface); border-radius: var(--radius-2);
            width: fit-content;
        }
        .typing-dot {
            width: 8px; height: 8px;
            background: var(--neutral-text-low);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* API Key Section */
        .api-key-section {
            padding: var(--space-3) var(--space-4);
            border-top: 1px solid var(--neutral-interactive);
            background: var(--neutral-surface);
        }
        .api-key-toggle {
            font-size: 12px; color: var(--neutral-text-low);
            cursor: pointer; display: flex; align-items: center; gap: var(--space-2);
        }
        .api-key-toggle:hover { color: var(--primary-interactive); }
        .api-key-form {
            margin-top: var(--space-3);
            display: flex; gap: var(--space-2); flex-wrap: wrap; align-items: center;
        }
        .api-key-input {
            flex: 1; min-width: 200px; padding: var(--space-2) var(--space-3);
            border: 1px solid var(--neutral-interactive); border-radius: var(--radius-2);
            font-size: 13px; font-family: var(--font-family);
        }
        .api-key-save {
            padding: var(--space-2) var(--space-4);
            background: var(--primary-interactive); color: white;
            border: none; border-radius: var(--radius-2);
            font-size: 13px; cursor: pointer;
        }
        .api-key-save:hover { background: var(--primary-interactive-hover); }
        .api-key-hint { font-size: 11px; color: var(--neutral-text-low); width: 100%; margin-top: var(--space-2); }

        /* Suggestions */
        .suggestions {
            display: flex; flex-wrap: wrap; gap: var(--space-2);
            padding: var(--space-4); border-top: 1px solid var(--neutral-interactive);
        }
        .suggestion-chip {
            padding: var(--space-2) var(--space-3);
            background: var(--neutral-surface);
            border: 1px solid var(--neutral-interactive);
            border-radius: var(--radius-full);
            font-size: 13px; cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-chip:hover {
            background: var(--primary-text-low);
            border-color: var(--primary-interactive);
            color: var(--primary-interactive);
        }

        /* Quick Stats */
        .quick-stats {
            display: flex; gap: var(--space-4);
            margin-top: var(--space-8); flex-wrap: wrap;
            justify-content: center;
        }
        .quick-stat {
            background: var(--neutral-background);
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-2);
            box-shadow: var(--shadow-level-1);
            text-align: center; min-width: 140px;
        }
        .quick-stat-value {
            font-size: 28px; font-weight: 700;
            color: var(--primary-interactive);
        }
        .quick-stat-label {
            font-size: 12px; color: var(--neutral-text-low);
            margin-top: var(--space-1);
        }

        /* View Report Button */
        .view-report-btn {
            margin-top: var(--space-8);
            padding: var(--space-4) var(--space-8);
            background: var(--neutral-background);
            border: 2px solid var(--primary-interactive);
            border-radius: var(--radius-2);
            font-size: 16px; font-weight: 600;
            color: var(--primary-interactive);
            cursor: pointer; transition: all 0.2s;
        }
        .view-report-btn:hover {
            background: var(--primary-interactive);
            color: white;
        }

        /* Report Section */
        .report-section { display: none; }
        .report-section.show { display: block; }
        .container { max-width: 1400px; margin: 0 auto; padding: var(--space-6); }

        /* Navigation Tabs */
        .tabs {
            display: flex; gap: var(--space-1); background: var(--neutral-background);
            padding: var(--space-2); border-radius: var(--radius-3);
            box-shadow: var(--shadow-level-1); margin-bottom: var(--space-5); flex-wrap: wrap;
        }
        .tab {
            flex: 1; min-width: 100px; padding: var(--space-3) var(--space-4);
            border: none; background: transparent; border-radius: var(--radius-2);
            cursor: pointer; font-family: var(--font-family); font-size: 14px;
            font-weight: 500; color: var(--neutral-text-low);
            transition: all 0.2s;
        }
        .tab:hover { background: var(--neutral-surface); color: var(--neutral-text-high); }
        .tab.active { background: var(--primary-interactive); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Metrics Grid */
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--space-4); margin-bottom: var(--space-6);
        }
        .metric-card {
            background: var(--neutral-background); border-radius: var(--radius-3);
            padding: var(--space-5); box-shadow: var(--shadow-level-1);
            border-left: 4px solid var(--primary-interactive);
        }
        .metric-card.success { border-left-color: var(--success-interactive); }
        .metric-card.warning { border-left-color: var(--warning-interactive); }
        .metric-card.danger { border-left-color: var(--danger-interactive); }
        .metric-value { font-size: 28px; font-weight: 700; line-height: 1.25; }
        .metric-label { font-size: 12px; color: var(--neutral-text-low); margin-top: var(--space-1); font-weight: 500; }
        .metric-delta { font-size: 12px; margin-top: var(--space-2); font-weight: 500; }
        .metric-delta.positive { color: var(--success-interactive); }
        .metric-delta.negative { color: var(--danger-interactive); }

        /* Charts Grid */
        .charts-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: var(--space-5);
        }
        .charts-grid.three-col { grid-template-columns: repeat(3, 1fr); }
        .chart-card {
            background: var(--neutral-background); border-radius: var(--radius-3);
            padding: var(--space-5); box-shadow: var(--shadow-level-1);
            min-height: 380px; position: relative; cursor: pointer;
            transition: box-shadow 0.2s;
        }
        .chart-card:hover { box-shadow: var(--shadow-level-2); }
        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-title { font-size: 14px; font-weight: 700; margin-bottom: var(--space-4); }
        .expand-hint {
            position: absolute; top: var(--space-3); right: var(--space-3);
            font-size: 16px; opacity: 0.4; transition: opacity 0.2s;
        }
        .chart-card:hover .expand-hint { opacity: 1; }

        /* Table */
        .table-container {
            max-height: 400px; overflow-y: auto; border-radius: var(--radius-2);
            border: 1px solid var(--neutral-interactive);
        }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th {
            background: var(--neutral-surface); padding: var(--space-3) var(--space-4);
            text-align: left; font-weight: 700; font-size: 12px; text-transform: uppercase;
            position: sticky; top: 0; border-bottom: 1px solid var(--neutral-interactive);
        }
        .data-table td { padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--neutral-interactive); }
        .data-table tr:hover { background: var(--neutral-surface); }

        /* Section Titles */
        .section-title {
            font-size: 20px; font-weight: 700;
            margin: var(--space-8) 0 var(--space-4);
            padding-bottom: var(--space-3); border-bottom: 2px solid var(--neutral-interactive);
        }
        .section-subtitle { color: var(--neutral-text-low); margin-bottom: var(--space-5); }

        /* Alert */
        .alert {
            padding: var(--space-4); border-radius: var(--radius-2);
            margin-bottom: var(--space-5);
        }
        .alert-info { background: var(--primary-text-low); border-left: 4px solid var(--primary-interactive); }
        .alert-success { background: var(--success-surface); border-left: 4px solid var(--success-interactive); }

        /* Summary Box */
        .summary-box {
            background: var(--neutral-surface); border-radius: var(--radius-2);
            padding: var(--space-5); margin-top: var(--space-5);
        }
        .summary-box h4 { font-weight: 700; margin-bottom: var(--space-3); }
        .summary-box p { color: var(--neutral-text-low); line-height: 1.6; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            padding: var(--space-6);
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: var(--neutral-background); border-radius: var(--radius-3);
            width: 95vw; max-width: 1200px; max-height: 90vh;
            padding: var(--space-6); position: relative; overflow: auto;
        }
        .modal-close {
            position: absolute; top: var(--space-4); right: var(--space-4);
            background: var(--neutral-surface); border: none; border-radius: var(--radius-full);
            width: 36px; height: 36px; font-size: 20px; cursor: pointer;
        }
        .modal-close:hover { background: var(--neutral-surface-highlight); }
        .modal-chart { width: 100%; height: 70vh; }

        /* Back Button */
        .back-btn {
            display: inline-flex; align-items: center; gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--neutral-surface);
            border: 1px solid var(--neutral-interactive);
            border-radius: var(--radius-2);
            font-size: 14px; cursor: pointer;
            margin-bottom: var(--space-5);
            transition: all 0.2s;
        }
        .back-btn:hover { background: var(--neutral-surface-highlight); }

        /* Responsive */
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr !important; }
            .home-title { font-size: 32px; }
            .quick-stats { flex-direction: column; align-items: center; }
            .tab { min-width: 70px; padding: var(--space-2) var(--space-3); font-size: 12px; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <span class="logo-text">Webinar Impact Report</span>
            </div>
            <span class="header-badge">üìÖ Janeiro 2026</span>
        </div>
    </header>

    <!-- Home Section with Chat -->
    <section class="home-section" id="home-section">
        <h1 class="home-title">Webinar Insights</h1>
        <p class="home-subtitle">Pergunte qualquer coisa sobre o impacto dos webinars nas lojas</p>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="chat-input" 
                    placeholder="Pergunte sobre convers√£o, GMV, status..." 
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="chat-send" onclick="sendMessage()" id="send-btn">‚û§</button>
            </div>
            <div class="api-key-section" id="api-key-section">
                <div class="api-key-toggle" onclick="toggleApiKey()">
                    <span id="api-status">üîí Configurar Gemini</span>
                </div>
                <div class="api-key-form" id="api-key-form" style="display: none;">
                    <input type="password" id="api-key-input" placeholder="Cole sua Google Gemini API Key" class="api-key-input">
                    <button onclick="saveApiKey()" class="api-key-save">Salvar</button>
                    <p class="api-key-hint">Sua chave fica salva apenas no seu navegador. <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary-interactive);">Obter API Key</a></p>
                </div>
            </div>
            <div class="suggestions">
                <span class="suggestion-chip" onclick="askQuestion('Fa√ßa um resumo executivo dos resultados')">üìã Resumo executivo</span>
                <span class="suggestion-chip" onclick="askQuestion('Qual a taxa de convers√£o para first seller e como ela variou por m√™s?')">üéØ Convers√£o First Seller</span>
                <span class="suggestion-chip" onclick="askQuestion('Compare o GMV dos participantes com a base geral por status')">üí∞ An√°lise de GMV</span>
                <span class="suggestion-chip" onclick="askQuestion('Analise a evolu√ß√£o de status das lojas participantes')">üìà Evolu√ß√£o de Status</span>
                <span class="suggestion-chip" onclick="askQuestion('Quais foram os webinars mais efetivos?')">üèÜ Top Webinars</span>
                <span class="suggestion-chip" onclick="askQuestion('Quais insights e recomenda√ß√µes voc√™ pode extrair dos dados?')">üí° Insights</span>
            </div>
        </div>

        <div class="quick-stats" id="quick-stats"></div>

        <button class="view-report-btn" onclick="showReport()">
            üìà Ver Report Completo
        </button>
    </section>

    <!-- Report Section -->
    <section class="report-section" id="report-section">
        <div class="container">
            <button class="back-btn" onclick="showHome()">‚Üê Voltar ao Chat</button>

            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">üìà Vis√£o Geral</button>
                <button class="tab" onclick="showTab('h1')">üéØ First Seller</button>
                <button class="tab" onclick="showTab('h2')">üí∞ GMV</button>
                <button class="tab" onclick="showTab('h3')">üìä Status</button>
                <button class="tab" onclick="showTab('profile')">üë§ Perfil</button>
            </div>

            <div class="tab-content active" id="tab-overview">
                <div class="metrics-grid" id="overview-metrics"></div>
                <div class="charts-grid" id="overview-charts"></div>
            </div>

            <div class="tab-content" id="tab-h1">
                <h2 class="section-title">Convers√£o para First Seller</h2>
                <p class="section-subtitle">An√°lise baseada APENAS na coluna first_seller_at</p>
                <div class="alert alert-info">
                    <p>üìä <strong>C√°lculo:</strong> Taxa = FS Ap√≥s Webinar / (Campo Vazio + FS Ap√≥s Webinar)</p>
                </div>
                <div class="metrics-grid" id="h1-metrics"></div>
                <div class="charts-grid" id="h1-charts"></div>
                <div id="h1-table"></div>
            </div>

            <div class="tab-content" id="tab-h2">
                <h2 class="section-title">An√°lise de GMV</h2>
                <p class="section-subtitle">Compara√ß√£o de GMV m√©dio por status</p>
                <div id="h2-summary"></div>
                <div class="metrics-grid" id="h2-metrics"></div>
                <div class="charts-grid" id="h2-charts"></div>
            </div>

            <div class="tab-content" id="tab-h3">
                <h2 class="section-title">Evolu√ß√£o de Status</h2>
                <p class="section-subtitle">Matriz de transi√ß√£o detalhada</p>
                <div class="metrics-grid" id="h3-metrics"></div>
                <div class="charts-grid" id="h3-charts"></div>
                <h3 class="section-title" style="font-size: 16px;">Matriz de Transi√ß√£o</h3>
                <div id="h3-matrix"></div>
                <h3 class="section-title" style="font-size: 16px;">Transi√ß√µes por Status Inicial</h3>
                <div id="h3-details"></div>
            </div>

            <div class="tab-content" id="tab-profile">
                <h2 class="section-title">Perfil dos Participantes</h2>
                <p class="section-subtitle">Caracter√≠sticas e comportamentos</p>
                <div class="metrics-grid" id="profile-metrics"></div>
                <div class="charts-grid" id="profile-charts"></div>
                <div id="profile-insights"></div>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal-overlay" id="chart-modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modal-chart-container" class="modal-chart"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // DADOS DO REPORT - Gerado em Janeiro 2026
        // ============================================================
        const REPORT_DATA = {
  "overview": {
    "participantCount": 1729,
    "controlCount": 97441,
    "webinarCount": 17,
    "monthCount": 4,
    "totalParticipations": 4567
  },
  "h1": {
    "byMonth": [
      {
        "month": "M06",
        "fullMonth": "Month 06 - June 2025",
        "total": 992,
        "withoutFirstSeller": 713,
        "fieldEmpty": 662,
        "afterWebinar": 51,
        "converted": 51,
        "conversionRate": 7.152875175315568
      },
      {
        "month": "M07",
        "fullMonth": "Month 07 - July 2025",
        "total": 528,
        "withoutFirstSeller": 273,
        "fieldEmpty": 246,
        "afterWebinar": 27,
        "converted": 27,
        "conversionRate": 9.89010989010989
      },
      {
        "month": "M08",
        "fullMonth": "Month 08 - August 2025",
        "total": 494,
        "withoutFirstSeller": 372,
        "fieldEmpty": 352,
        "afterWebinar": 20,
        "converted": 20,
        "conversionRate": 5.376344086021505
      },
      {
        "month": "M09",
        "fullMonth": "Month 09 - September 2025",
        "total": 1593,
        "withoutFirstSeller": 1054,
        "fieldEmpty": 1003,
        "afterWebinar": 51,
        "converted": 51,
        "conversionRate": 4.838709677419355
      }
    ],
    "total": 1729,
    "withoutFirstSeller": 802,
    "fieldEmpty": 682,
    "afterWebinar": 120,
    "converted": 120,
    "overallRate": 14.962593516209477
  },
  "h2": {
    "participants": {
      "mean": 31331.489747219424,
      "median": 1711.25,
      "std": 150418.66271777524,
      "count": 989
    },
    "allStores": {
      "mean": 13858.947171789712,
      "median": 1066.99,
      "std": 79251.79065111888,
      "count": 37575
    },
    "control": {
      "mean": 13386.625939430336,
      "median": 1051.48,
      "std": 76357.91547447423,
      "count": 36586
    },
    "diffPct": 126.07409754036422,
    "aboveAvgPct": 21.73913043478261,
    "byStatus": {
      "no-seller": {
        "participants": { "mean": 207.96928571428566, "median": 172.18, "std": 281.6646949316126, "count": 28 },
        "allStores": { "mean": 1749.3280238726734, "median": 193.71, "std": 14519.128306268713, "count": 2262 },
        "diffPct": -88.11147578520568
      },
      "struggling-seller": {
        "participants": { "mean": 624.0324157303363, "median": 290.69, "std": 1419.982286704407, "count": 178 },
        "allStores": { "mean": 934.5038223319016, "median": 267.9, "std": 5020.58840497144, "count": 8105 },
        "diffPct": -33.22312859318591
      },
      "tiny-seller": {
        "participants": { "mean": 1495.8542537313435, "median": 673.86, "std": 3235.7362595492464, "count": 268 },
        "allStores": { "mean": 1764.8485233798203, "median": 650.97, "std": 5679.445405423885, "count": 10971 },
        "diffPct": -15.241776621901359
      },
      "small-seller": {
        "participants": { "mean": 6881.817661290325, "median": 3095.44, "std": 15051.37148422009, "count": 248 },
        "allStores": { "mean": 6567.860817214172, "median": 2937.74, "std": 19702.11159100637, "count": 8737 },
        "diffPct": 4.780199410640393
      },
      "medium-seller": {
        "participants": { "mean": 25088.950414201183, "median": 16468.29, "std": 29467.110005339022, "count": 169 },
        "allStores": { "mean": 26854.008502548913, "median": 15998.58, "std": 38209.32124555936, "count": 4708 },
        "diffPct": -6.572791872692658
      },
      "large-seller": {
        "participants": { "mean": 121595.04875000005, "median": 60969.25, "std": 158505.79808159082, "count": 40 },
        "allStores": { "mean": 79362.2536234817, "median": 51889.74, "std": 96627.87469959512, "count": 988 },
        "diffPct": 53.21521655229624
      },
      "top-seller": {
        "participants": { "mean": 338940.1406896551, "median": 194518.28, "std": 504521.36334328423, "count": 58 },
        "allStores": { "mean": 253777.66087202745, "median": 139001.05, "std": 418173.458732442, "count": 883 },
        "diffPct": 33.55791030817821
      }
    }
  },
  "h3": {
    "total": 1698,
    "transitions": { "upgrade": 418, "maintained": 1023, "downgrade": 257, "unknown": 31 },
    "upgradeRate": 24.617196702002357,
    "maintainedRate": 60.24734982332155,
    "downgradeRate": 15.135453474676089,
    "transitionMatrix": {
      "no-seller": { "no-seller": 267, "struggling-seller": 134, "tiny-seller": 28, "small-seller": 5, "medium-seller": 3, "large-seller": 2, "top-seller": 1 },
      "struggling-seller": { "no-seller": 113, "struggling-seller": 245, "tiny-seller": 87, "small-seller": 15, "medium-seller": 1, "large-seller": 0, "top-seller": 0 },
      "tiny-seller": { "no-seller": 15, "struggling-seller": 64, "tiny-seller": 180, "small-seller": 66, "medium-seller": 10, "large-seller": 1, "top-seller": 1 },
      "small-seller": { "no-seller": 2, "struggling-seller": 10, "tiny-seller": 30, "small-seller": 152, "medium-seller": 36, "large-seller": 1, "top-seller": 1 },
      "medium-seller": { "no-seller": 0, "struggling-seller": 2, "tiny-seller": 3, "small-seller": 12, "medium-seller": 118, "large-seller": 9, "top-seller": 5 },
      "large-seller": { "no-seller": 0, "struggling-seller": 0, "tiny-seller": 0, "small-seller": 0, "medium-seller": 3, "large-seller": 23, "top-seller": 12 },
      "top-seller": { "no-seller": 0, "struggling-seller": 0, "tiny-seller": 0, "small-seller": 0, "medium-seller": 0, "large-seller": 3, "top-seller": 38 }
    },
    "transitionsByInitial": {
      "no-seller": { "total": 440, "upgrade": 173, "maintained": 267, "downgrade": 0, "destinations": { "no-seller": 267, "struggling-seller": 134, "tiny-seller": 28, "small-seller": 5, "medium-seller": 3, "large-seller": 2, "top-seller": 1 } },
      "struggling-seller": { "total": 461, "upgrade": 103, "maintained": 245, "downgrade": 113, "destinations": { "no-seller": 113, "struggling-seller": 245, "tiny-seller": 87, "small-seller": 15, "medium-seller": 1, "large-seller": 0, "top-seller": 0 } },
      "tiny-seller": { "total": 337, "upgrade": 78, "maintained": 180, "downgrade": 79, "destinations": { "no-seller": 15, "struggling-seller": 64, "tiny-seller": 180, "small-seller": 66, "medium-seller": 10, "large-seller": 1, "top-seller": 1 } },
      "small-seller": { "total": 232, "upgrade": 38, "maintained": 152, "downgrade": 42, "destinations": { "no-seller": 2, "struggling-seller": 10, "tiny-seller": 30, "small-seller": 152, "medium-seller": 36, "large-seller": 1, "top-seller": 1 } },
      "medium-seller": { "total": 149, "upgrade": 14, "maintained": 118, "downgrade": 17, "destinations": { "no-seller": 0, "struggling-seller": 2, "tiny-seller": 3, "small-seller": 12, "medium-seller": 118, "large-seller": 9, "top-seller": 5 } },
      "large-seller": { "total": 38, "upgrade": 12, "maintained": 23, "downgrade": 3, "destinations": { "no-seller": 0, "struggling-seller": 0, "tiny-seller": 0, "small-seller": 0, "medium-seller": 3, "large-seller": 23, "top-seller": 12 } },
      "top-seller": { "total": 41, "upgrade": 0, "maintained": 38, "downgrade": 3, "destinations": { "no-seller": 0, "struggling-seller": 0, "tiny-seller": 0, "small-seller": 0, "medium-seller": 0, "large-seller": 3, "top-seller": 38 } }
    },
    "participantsDist": { "no-seller": 416, "struggling-seller": 461, "tiny-seller": 328, "small-seller": 253, "medium-seller": 171, "large-seller": 40, "top-seller": 58 },
    "controlDist": { "no-seller": 40921, "struggling-seller": 20511, "tiny-seller": 13205, "small-seller": 8903, "medium-seller": 4624, "large-seller": 961, "top-seller": 834 }
  },
  "profile": {
    "ageCategories": { "0-30 dias": 2, "31-90 dias": 14, "91-180 dias": 181, "181-365 dias": 483, "1-2 anos": 436, "2+ anos": 613 },
    "ageStats": { "mean": 742.812030075188, "median": 512, "std": 669.3361013757167, "count": 1729 },
    "timeCategories": { "0-30 dias": 105, "31-60 dias": 148, "61-90 dias": 131, "91-120 dias": 98, "121-180 dias": 133, "181-365 dias": 182, "365+ dias": 250 },
    "timeToFirstSellerStats": { "mean": 283.02196752626554, "median": 132, "std": 374.14841415085806, "count": 1047 },
    "statusAtWebinar": { "no-seller": 440, "struggling-seller": 461, "tiny-seller": 337, "small-seller": 232, "medium-seller": 149, "large-seller": 38, "top-seller": 41, "sem status": 31 },
    "participationType": { "live": 3063, "on-demand": 908, "registered": 596, "outro": 0 },
    "webinarCountDist": { "1": 1225, "2": 324, "3": 102, "4": 37, "5+": 41 },
    "avgWebinarsByMonth": [
      { "month": "M06", "fullMonth": "Month 06 - June 2025", "uniqueStores": 992, "avgWebinars": 1.2147177419354838 },
      { "month": "M07", "fullMonth": "Month 07 - July 2025", "uniqueStores": 528, "avgWebinars": 1.2746212121212122 },
      { "month": "M08", "fullMonth": "Month 08 - August 2025", "uniqueStores": 494, "avgWebinars": 1.2105263157894737 },
      { "month": "M09", "fullMonth": "Month 09 - September 2025", "uniqueStores": 1593, "avgWebinars": 1.3126177024482109 }
    ],
    "topWebinars": [
      ["Esquenta D2C Summit 1609", 656],
      ["Estrat√©gias para a sua loja vender em poucos dias- 0306", 575],
      ["Nuvem Chat Evolua seu atendimento com a IA que conversa como a sua marca 1006", 374],
      ["Atraindo visitantes: prepare sua loja para a Black Friday 2609", 369],
      ["Frete e estoque sem complica√ß√£o sua opera√ß√£o pronta para a Black Friday 1809", 359],
      ["Da vitrine ao carrinho: preparando sua loja para a Black Friday e Natal 0909", 355],
      ["Loja Pronta: configure sua loja e comece a vender o quanto antes 0409", 352],
      ["Sua Loja no Ar: finalize agora e comece a faturar! 1208", 222],
      ["O Segredo das Lojas que Vendem Moda 1706", 210],
      ["Guia Nuvemshop: Como impulsionar suas vendas em Datas Especiais 2207", 190]
    ],
    "totalParticipants": 1729
  }
};

        // ============================================================
        // CONFIGURA√á√ÉO DA IA (Google Gemini)
        // ============================================================
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';

        // Contexto completo dos dados para a IA
        function getDataContext() {
            return `
## CONTEXTO: An√°lise de Impacto dos Webinars Nuvemshop (Junho-Setembro 2025)

### VIS√ÉO GERAL
- Total de lojas participantes: ${REPORT_DATA.overview.participantCount.toLocaleString()}
- Total de participa√ß√µes: ${REPORT_DATA.overview.totalParticipations.toLocaleString()}
- Webinars realizados: ${REPORT_DATA.overview.webinarCount}
- Per√≠odo: ${REPORT_DATA.overview.monthCount} meses (Junho a Setembro 2025)
- Grupo de controle: ${REPORT_DATA.overview.controlCount.toLocaleString()} lojas

### HIP√ìTESE 1: CONVERS√ÉO PARA FIRST SELLER
A taxa mede quantas lojas que N√ÉO tinham first_seller no momento do webinar passaram a ter depois.
- Taxa geral de convers√£o: ${REPORT_DATA.h1.overallRate.toFixed(2)}%
- Total sem First Seller no webinar (denominador): ${REPORT_DATA.h1.withoutFirstSeller}
  - Campo vazio (nunca venderam): ${REPORT_DATA.h1.fieldEmpty}
  - First Seller ap√≥s webinar: ${REPORT_DATA.h1.afterWebinar}
- Converteram (numerador): ${REPORT_DATA.h1.converted}

Convers√£o por m√™s:
${REPORT_DATA.h1.byMonth.map(m => `- ${m.fullMonth}: ${m.conversionRate.toFixed(2)}% (${m.converted}/${m.withoutFirstSeller})`).join('\n')}

### HIP√ìTESE 2: AN√ÅLISE DE GMV
GMV D-30 (√∫ltimos 30 dias):
- Participantes: R$ ${REPORT_DATA.h2.participants.mean.toFixed(2)} m√©dio (${REPORT_DATA.h2.participants.count} lojas)
- Base Geral: R$ ${REPORT_DATA.h2.allStores.mean.toFixed(2)} m√©dio (${REPORT_DATA.h2.allStores.count} lojas)
- Diferen√ßa: ${REPORT_DATA.h2.diffPct > 0 ? '+' : ''}${REPORT_DATA.h2.diffPct.toFixed(2)}%
- ${REPORT_DATA.h2.aboveAvgPct.toFixed(1)}% dos participantes t√™m GMV acima da m√©dia do seu status

GMV por status (Participantes vs Base):
${Object.entries(REPORT_DATA.h2.byStatus).map(([status, data]) => 
    `- ${status}: R$ ${data.participants.mean.toFixed(0)} vs R$ ${data.allStores.mean.toFixed(0)} (${data.diffPct > 0 ? '+' : ''}${data.diffPct.toFixed(1)}%)`
).join('\n')}

### HIP√ìTESE 3: EVOLU√á√ÉO DE STATUS
Comparando status no webinar vs status atual (Jan/2026):
- Upgrade: ${REPORT_DATA.h3.upgradeRate.toFixed(1)}% (${REPORT_DATA.h3.transitions.upgrade} lojas)
- Mantiveram: ${REPORT_DATA.h3.maintainedRate.toFixed(1)}% (${REPORT_DATA.h3.transitions.maintained} lojas)
- Downgrade: ${REPORT_DATA.h3.downgradeRate.toFixed(1)}% (${REPORT_DATA.h3.transitions.downgrade} lojas)

Transi√ß√µes por status inicial:
${Object.entries(REPORT_DATA.h3.transitionsByInitial).map(([status, data]) => 
    `- ${status} (${data.total}): ${data.upgrade} upgrade, ${data.maintained} manteve, ${data.downgrade} downgrade`
).join('\n')}

### PERFIL DOS PARTICIPANTES
- Idade m√©dia das lojas: ${REPORT_DATA.profile.ageStats.mean.toFixed(0)} dias (${(REPORT_DATA.profile.ageStats.mean/365).toFixed(1)} anos)
- Tempo m√©dio at√© First Seller: ${REPORT_DATA.profile.timeToFirstSellerStats.mean.toFixed(0)} dias
- Lojas com First Seller: ${REPORT_DATA.profile.timeToFirstSellerStats.count}

Distribui√ß√£o por idade:
${Object.entries(REPORT_DATA.profile.ageCategories).map(([cat, count]) => `- ${cat}: ${count} lojas`).join('\n')}

Tempo at√© First Seller:
${Object.entries(REPORT_DATA.profile.timeCategories).map(([cat, count]) => `- ${cat}: ${count} lojas`).join('\n')}

Status no momento do webinar:
${Object.entries(REPORT_DATA.profile.statusAtWebinar).map(([status, count]) => `- ${status}: ${count} lojas`).join('\n')}

Tipo de participa√ß√£o:
${Object.entries(REPORT_DATA.profile.participationType).filter(([k,v]) => v > 0).map(([type, count]) => `- ${type}: ${count}`).join('\n')}

Engajamento:
- 1 webinar: ${REPORT_DATA.profile.webinarCountDist['1'] || 0} lojas
- 2 webinars: ${REPORT_DATA.profile.webinarCountDist['2'] || 0} lojas
- 3 webinars: ${REPORT_DATA.profile.webinarCountDist['3'] || 0} lojas
- 4 webinars: ${REPORT_DATA.profile.webinarCountDist['4'] || 0} lojas
- 5+ webinars: ${REPORT_DATA.profile.webinarCountDist['5+'] || 0} lojas

Top 5 Webinars:
${REPORT_DATA.profile.topWebinars.slice(0, 5).map((w, i) => `${i+1}. ${w[0]} (${w[1]} participantes)`).join('\n')}
`;
        }

        const SYSTEM_PROMPT = `Voc√™ √© um analista de dados especialista da Nuvemshop, analisando o impacto dos webinars nas lojas.

REGRAS:
1. Responda SEMPRE em portugu√™s brasileiro
2. Seja direto e objetivo, mas anal√≠tico
3. Use dados espec√≠ficos do contexto para embasar suas respostas
4. Formate com **negrito** para destacar n√∫meros importantes
5. Use emojis para tornar a leitura mais agrad√°vel
6. Quando relevante, sugira insights ou pr√≥ximos passos
7. Se a pergunta n√£o tiver rela√ß√£o com os dados, explique educadamente o que voc√™ pode responder

CONTEXTO DOS DADOS:
${getDataContext()}`;

        // Fallback para respostas locais (sem API)
        function getLocalResponse(question) {
            const q = question.toLowerCase();
            const data = REPORT_DATA;
            
            if (q.includes('taxa') || q.includes('convers√£o') || q.includes('first seller')) {
                return `üìä **Taxa de Convers√£o para First Seller: ${data.h1.overallRate.toFixed(1)}%**

De ${data.h1.withoutFirstSeller} lojas sem First Seller no momento do webinar, ${data.h1.converted} converteram ap√≥s participar.

**Por m√™s:**
${data.h1.byMonth.map(m => `‚Ä¢ ${m.fullMonth}: **${m.conversionRate.toFixed(1)}%**`).join('\n')}

üí° Julho teve a melhor taxa (9.9%), enquanto Setembro teve a menor (4.8%).`;
            }
            
            if (q.includes('gmv') || q.includes('faturamento') || q.includes('receita')) {
                return `üí∞ **An√°lise de GMV (D-30)**

Participantes t√™m GMV **${data.h2.diffPct.toFixed(0)}% maior** que a base geral!

‚Ä¢ Participantes: **R$ ${formatNumber(data.h2.participants.mean)}** m√©dio
‚Ä¢ Base Geral: **R$ ${formatNumber(data.h2.allStores.mean)}** m√©dio

**Destaque por status:**
‚Ä¢ Large-seller: +53% acima da m√©dia
‚Ä¢ Top-seller: +34% acima da m√©dia
‚Ä¢ Small-seller: +5% acima da m√©dia

‚ö†Ô∏è No-seller e Struggling est√£o abaixo da m√©dia do status.`;
            }
            
            if (q.includes('upgrade') || q.includes('status') || q.includes('evolu')) {
                return `üìà **Evolu√ß√£o de Status**

‚Ä¢ ‚úÖ Upgrade: **${data.h3.upgradeRate.toFixed(1)}%** (${data.h3.transitions.upgrade} lojas)
‚Ä¢ ‚û°Ô∏è Mantiveram: **${data.h3.maintainedRate.toFixed(1)}%** (${data.h3.transitions.maintained} lojas)
‚Ä¢ ‚¨áÔ∏è Downgrade: **${data.h3.downgradeRate.toFixed(1)}%** (${data.h3.transitions.downgrade} lojas)

**Melhor evolu√ß√£o:**
‚Ä¢ No-seller: 39% fizeram upgrade
‚Ä¢ Large-seller: 32% subiram para Top-seller

üí° A maioria das lojas manteve ou melhorou seu status ap√≥s os webinars.`;
            }
            
            if (q.includes('perfil') || q.includes('quem') || q.includes('participante')) {
                return `üë§ **Perfil dos Participantes**

‚Ä¢ **${data.profile.totalParticipants}** lojas √∫nicas
‚Ä¢ Idade m√©dia: **${(data.profile.ageStats.mean/365).toFixed(1)} anos**
‚Ä¢ ${data.profile.ageCategories['2+ anos']} lojas t√™m mais de 2 anos

**Status no webinar:**
‚Ä¢ Struggling-seller: ${data.profile.statusAtWebinar['struggling-seller']} (mais comum)
‚Ä¢ No-seller: ${data.profile.statusAtWebinar['no-seller']}
‚Ä¢ Tiny-seller: ${data.profile.statusAtWebinar['tiny-seller']}

**Participa√ß√£o:**
‚Ä¢ ${data.profile.participationType.live} ao vivo
‚Ä¢ ${data.profile.participationType['on-demand']} on-demand`;
            }
            
            if (q.includes('webinar') && (q.includes('top') || q.includes('melhor') || q.includes('popular'))) {
                return `üèÜ **Top 5 Webinars por Participa√ß√£o**

${data.profile.topWebinars.slice(0, 5).map((w, i) => `${i+1}. **${w[0]}**\n   ‚Üí ${w[1]} participantes`).join('\n\n')}

üí° Webinars sobre Black Friday tiveram grande ades√£o!`;
            }
            
            return `ü§î Posso te ajudar com an√°lises sobre:

‚Ä¢ **Taxa de convers√£o** para First Seller
‚Ä¢ **GMV** dos participantes vs base geral
‚Ä¢ **Evolu√ß√£o de status** (upgrade/downgrade)
‚Ä¢ **Perfil** dos participantes
‚Ä¢ **Top webinars** por participa√ß√£o

Ou clique em "Ver Report Completo" para explorar todos os dados!`;
        }

        // Chamar API do Google Gemini
        async function callGemini(question) {
            if (!GEMINI_API_KEY) {
                return getLocalResponse(question);
            }

            const fullPrompt = `${SYSTEM_PROMPT}

PERGUNTA DO USU√ÅRIO:
${question}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: fullPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2000,
                            topP: 0.8,
                            topK: 40
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Gemini Error:', error);
                    if (error.error?.status === 'INVALID_ARGUMENT' || error.error?.code === 400) {
                        return '‚ö†Ô∏è API Key inv√°lida. Por favor, verifique sua chave nas configura√ß√µes.';
                    }
                    return getLocalResponse(question);
                }

                const data = await response.json();
                
                // Extrair texto da resposta do Gemini
                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    return data.candidates[0].content.parts[0].text;
                }
                
                console.error('Unexpected Gemini response format:', data);
                return getLocalResponse(question);
            } catch (error) {
                console.error('Error calling Gemini:', error);
                return getLocalResponse(question);
            }
        }

        // Alias para compatibilidade
        const callOpenAI = callGemini;

        // Fun√ß√µes de gerenciamento da API Key
        function toggleApiKey() {
            const form = document.getElementById('api-key-form');
            form.style.display = form.style.display === 'none' ? 'flex' : 'none';
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                GEMINI_API_KEY = key;
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('api-status').innerHTML = '‚úÖ Gemini Configurado';
                document.getElementById('api-key-form').style.display = 'none';
                input.value = '';
            }
        }

        function updateApiStatus() {
            const status = document.getElementById('api-status');
            if (GEMINI_API_KEY) {
                status.innerHTML = '‚úÖ Gemini Configurado';
            } else {
                status.innerHTML = 'üîí Configurar Gemini';
            }
        }

        // ============================================================
        // CONSTANTES E CONFIGURA√á√ïES
        // ============================================================
        const CHART_COLORS = {
            primary: '#0066E5', primaryLight: '#E6F0FF', secondary: '#8C8C8C',
            success: '#00A650', successLight: '#E6F9ED',
            warning: '#FF9500', warningLight: '#FFF4E6',
            danger: '#E53935', dangerLight: '#FFE6E6'
        };
        const STATUS_LIST = ['no-seller', 'struggling-seller', 'tiny-seller', 'small-seller', 'medium-seller', 'large-seller', 'top-seller'];
        const STATUS_LABELS = {
            'no-seller': 'No Seller', 'struggling-seller': 'Struggling', 'tiny-seller': 'Tiny',
            'small-seller': 'Small', 'medium-seller': 'Medium', 'large-seller': 'Large', 'top-seller': 'Top'
        };
        const STATUS_ORDER = { 'no-seller': 0, 'struggling-seller': 1, 'tiny-seller': 2, 'small-seller': 3, 'medium-seller': 4, 'large-seller': 5, 'top-seller': 6 };
        const STATUS_COLORS = {
            'no-seller': '#E53935', 'struggling-seller': '#FF9500', 'tiny-seller': '#FFB800',
            'small-seller': '#84CC16', 'medium-seller': '#00A650', 'large-seller': '#00B8A9', 'top-seller': '#0066E5'
        };
        const PLOTLY_LAYOUT = {
            font: { family: 'Geist, -apple-system, sans-serif', size: 12, color: '#14171A' },
            paper_bgcolor: 'white', plot_bgcolor: 'white',
            margin: { t: 50, r: 20, b: 50, l: 50 }
        };

        let chartConfigs = {};

        // ============================================================
        // FUN√á√ïES DE CHAT
        // ============================================================
        let isProcessing = false;

        async function sendMessage() {
            if (isProcessing) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            isProcessing = true;
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;

            addMessage(message, 'user');
            input.value = '';

            // Mostrar indicador de digita√ß√£o
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await callOpenAI(message);
                document.getElementById('typing')?.remove();
                addMessage(response, 'assistant');
            } catch (error) {
                document.getElementById('typing')?.remove();
                addMessage('Desculpe, ocorreu um erro. Tente novamente.', 'assistant');
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
            }
        }

        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.classList.add('has-messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            // Converter markdown para HTML
            let htmlText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `<div class="message-content">${htmlText}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function askQuestion(question) {
            document.getElementById('chat-input').value = question;
            sendMessage();
        }

        // ============================================================
        // FUN√á√ïES DE NAVEGA√á√ÉO
        // ============================================================
        function showReport() {
            document.getElementById('home-section').style.display = 'none';
            document.getElementById('report-section').classList.add('show');
            renderReport();
        }

        function showHome() {
            document.getElementById('home-section').style.display = 'flex';
            document.getElementById('report-section').classList.remove('show');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ============================================================
        // FUN√á√ïES DE MODAL
        // ============================================================
        function openModal(chartId) {
            const config = chartConfigs[chartId];
            if (!config) return;
            const modal = document.getElementById('chart-modal');
            const container = document.getElementById('modal-chart-container');
            const modalLayout = { ...config.layout, height: window.innerHeight * 0.65, margin: { t: 60, r: 40, b: 60, l: 60 } };
            Plotly.newPlot(container, config.data, modalLayout, { responsive: true });
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('chart-modal').classList.remove('show');
            document.body.style.overflow = '';
            Plotly.purge('modal-chart-container');
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        function createChart(containerId, data, layout) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const parent = container.parentElement;
            if (parent && !parent.querySelector('.expand-hint')) {
                const hint = document.createElement('span');
                hint.className = 'expand-hint';
                hint.innerHTML = 'üîç';
                parent.prepend(hint);
            }
            chartConfigs[containerId] = { data, layout: { ...PLOTLY_LAYOUT, ...layout } };
            Plotly.newPlot(containerId, data, { ...PLOTLY_LAYOUT, ...layout, height: 320 }, { responsive: true });
            if (parent) parent.onclick = () => openModal(containerId);
        }

        // ============================================================
        // FUN√á√ïES DE RENDERIZA√á√ÉO
        // ============================================================
        function renderQuickStats() {
            const o = REPORT_DATA.overview;
            const h1 = REPORT_DATA.h1;
            const h3 = REPORT_DATA.h3;
            
            document.getElementById('quick-stats').innerHTML = `
                <div class="quick-stat">
                    <div class="quick-stat-value">${o.participantCount.toLocaleString()}</div>
                    <div class="quick-stat-label">Lojas Participantes</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${h1.overallRate.toFixed(1)}%</div>
                    <div class="quick-stat-label">Convers√£o First Seller</div>
                </div>
                <div class="quick-stat">
                    <div class="quick-stat-value">${h3.upgradeRate.toFixed(1)}%</div>
                    <div class="quick-stat-label">Taxa de Upgrade</div>
                </div>
            `;
        }

        function renderReport() {
            renderOverview();
            renderH1();
            renderH2();
            renderH3();
            renderProfile();
        }

        function renderOverview() {
            const o = REPORT_DATA.overview;
            const h1 = REPORT_DATA.h1;
            const h2 = REPORT_DATA.h2;
            const h3 = REPORT_DATA.h3;

            document.getElementById('overview-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${o.participantCount.toLocaleString()}</div><div class="metric-label">Lojas Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${o.controlCount.toLocaleString()}</div><div class="metric-label">Grupo de Controle</div></div>
                <div class="metric-card"><div class="metric-value">${o.totalParticipations.toLocaleString()}</div><div class="metric-label">Total Participa√ß√µes</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.overallRate.toFixed(1)}%</div><div class="metric-label">Convers√£o First Seller</div></div>
                <div class="metric-card ${h2.diffPct > 0 ? 'success' : 'danger'}"><div class="metric-value">${h2.diffPct > 0 ? '+' : ''}${h2.diffPct.toFixed(1)}%</div><div class="metric-label">GMV vs Base</div></div>
                <div class="metric-card success"><div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div><div class="metric-label">Taxa de Upgrade</div></div>
            `;

            document.getElementById('overview-charts').innerHTML = `
                <div class="chart-card"><div id="overview-chart1"></div></div>
                <div class="chart-card"><div id="overview-chart2"></div></div>
            `;

            if (h1.byMonth.length > 0) {
                createChart('overview-chart1', [{
                    x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.conversionRate),
                    type: 'bar', marker: { color: CHART_COLORS.primary },
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'), textposition: 'outside'
                }], { title: { text: 'Taxa de Convers√£o por M√™s (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });
            }

            createChart('overview-chart2', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie', hole: 0.45,
                marker: { colors: [CHART_COLORS.success, CHART_COLORS.warning, CHART_COLORS.danger] }
            }], { title: { text: 'Evolu√ß√£o de Status', font: { size: 14 } }, showlegend: false });
        }

        function renderH1() {
            const h1 = REPORT_DATA.h1;
            document.getElementById('h1-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${h1.total.toLocaleString()}</div><div class="metric-label">Total Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${h1.fieldEmpty.toLocaleString()}</div><div class="metric-label">Campo Vazio</div></div>
                <div class="metric-card warning"><div class="metric-value">${h1.withoutFirstSeller.toLocaleString()}</div><div class="metric-label">Denominador</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.afterWebinar.toLocaleString()}</div><div class="metric-label">FS Ap√≥s Webinar</div></div>
                <div class="metric-card success"><div class="metric-value">${h1.overallRate.toFixed(1)}%</div><div class="metric-label">Taxa Convers√£o</div></div>
            `;

            document.getElementById('h1-charts').innerHTML = `
                <div class="chart-card"><div id="h1-chart1"></div></div>
                <div class="chart-card"><div id="h1-chart2"></div></div>
            `;

            if (h1.byMonth.length > 0) {
                createChart('h1-chart1', [{
                    x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.conversionRate),
                    type: 'scatter', mode: 'lines+markers+text',
                    text: h1.byMonth.map(m => m.conversionRate.toFixed(1) + '%'), textposition: 'top center',
                    line: { color: CHART_COLORS.primary, width: 3 }, marker: { size: 10 }
                }], { title: { text: 'Taxa de Convers√£o por M√™s (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });

                createChart('h1-chart2', [
                    { x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.fieldEmpty), type: 'bar', name: 'Campo Vazio', marker: { color: CHART_COLORS.secondary } },
                    { x: h1.byMonth.map(m => m.month), y: h1.byMonth.map(m => m.afterWebinar), type: 'bar', name: 'FS Ap√≥s Webinar', marker: { color: CHART_COLORS.success } }
                ], { title: { text: 'Composi√ß√£o do Denominador', font: { size: 14 } }, barmode: 'stack' });
            }

            let tableHTML = `<div class="chart-card full-width"><h3 class="chart-title">üìã Dados por M√™s</h3>
                <div class="table-container"><table class="data-table">
                <thead><tr><th>M√™s</th><th>Total</th><th>Campo Vazio</th><th>FS Ap√≥s (Num.)</th><th>Sem FS (Denom.)</th><th>Taxa</th></tr></thead><tbody>`;
            h1.byMonth.forEach(m => {
                tableHTML += `<tr><td>${m.fullMonth}</td><td>${m.total.toLocaleString()}</td><td>${m.fieldEmpty.toLocaleString()}</td>
                    <td style="color:var(--success-interactive)"><strong>${m.afterWebinar.toLocaleString()}</strong></td>
                    <td><strong>${m.withoutFirstSeller.toLocaleString()}</strong></td>
                    <td><strong style="color:var(--success-interactive)">${m.conversionRate.toFixed(2)}%</strong></td></tr>`;
            });
            tableHTML += `<tr style="background:var(--neutral-surface);font-weight:bold"><td>TOTAL</td><td>${h1.total.toLocaleString()}</td>
                <td>${h1.fieldEmpty.toLocaleString()}</td><td style="color:var(--success-interactive)">${h1.afterWebinar.toLocaleString()}</td>
                <td>${h1.withoutFirstSeller.toLocaleString()}</td><td style="color:var(--success-interactive)">${h1.overallRate.toFixed(2)}%</td></tr>`;
            tableHTML += '</tbody></table></div></div>';
            document.getElementById('h1-table').innerHTML = tableHTML;
        }

        function renderH2() {
            const h2 = REPORT_DATA.h2;
            const summaryClass = h2.diffPct > 0 ? 'alert-success' : 'alert-info';
            document.getElementById('h2-summary').innerHTML = `<div class="alert ${summaryClass}">
                <p><strong>Participantes vs Base:</strong> GMV m√©dio ${h2.diffPct > 0 ? 'maior' : 'menor'} em ${Math.abs(h2.diffPct).toFixed(1)}%.</p></div>`;

            document.getElementById('h2-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">R$ ${formatNumber(h2.participants.mean)}</div><div class="metric-label">GMV Participantes</div></div>
                <div class="metric-card"><div class="metric-value">R$ ${formatNumber(h2.allStores.mean)}</div><div class="metric-label">GMV Base Geral</div></div>
                <div class="metric-card ${h2.diffPct > 0 ? 'success' : 'danger'}"><div class="metric-value">${h2.diffPct > 0 ? '+' : ''}${h2.diffPct.toFixed(1)}%</div><div class="metric-label">Diferen√ßa</div></div>
                <div class="metric-card success"><div class="metric-value">${h2.aboveAvgPct.toFixed(1)}%</div><div class="metric-label">Acima da M√©dia</div></div>
            `;

            document.getElementById('h2-charts').innerHTML = `
                <div class="chart-card"><div id="h2-chart1"></div></div>
                <div class="chart-card"><div id="h2-chart2"></div></div>
                <div class="chart-card full-width"><div id="h2-chart3"></div></div>
            `;

            createChart('h2-chart1', [{
                x: ['Participantes', 'Base Geral', 'Controle'],
                y: [h2.participants.mean, h2.allStores.mean, h2.control.mean],
                type: 'bar', marker: { color: [CHART_COLORS.primary, CHART_COLORS.secondary, '#E1E1E3'] },
                text: ['R$ ' + formatNumber(h2.participants.mean), 'R$ ' + formatNumber(h2.allStores.mean), 'R$ ' + formatNumber(h2.control.mean)],
                textposition: 'outside'
            }], { title: { text: 'GMV M√©dio (D-30)', font: { size: 14 } } });

            const statusData = STATUS_LIST.filter(s => h2.byStatus[s]?.participants?.count > 5);
            if (statusData.length > 0) {
                createChart('h2-chart2', [
                    { x: statusData.map(s => STATUS_LABELS[s]), y: statusData.map(s => h2.byStatus[s].participants.mean), type: 'bar', name: 'Participantes', marker: { color: CHART_COLORS.primary } },
                    { x: statusData.map(s => STATUS_LABELS[s]), y: statusData.map(s => h2.byStatus[s].allStores.mean), type: 'bar', name: 'Base Geral', marker: { color: CHART_COLORS.secondary } }
                ], { title: { text: 'GMV por Status', font: { size: 14 } }, barmode: 'group' });

                createChart('h2-chart3', [{
                    x: statusData.map(s => STATUS_LABELS[s]),
                    y: statusData.map(s => h2.byStatus[s].diffPct),
                    type: 'bar',
                    marker: { color: statusData.map(s => h2.byStatus[s].diffPct > 0 ? CHART_COLORS.success : CHART_COLORS.danger) },
                    text: statusData.map(s => (h2.byStatus[s].diffPct > 0 ? '+' : '') + h2.byStatus[s].diffPct.toFixed(1) + '%'),
                    textposition: 'outside'
                }], { title: { text: 'Diferen√ßa GMV (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });
            }
        }

        function renderH3() {
            const h3 = REPORT_DATA.h3;
            document.getElementById('h3-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${h3.total.toLocaleString()}</div><div class="metric-label">Lojas Analisadas</div></div>
                <div class="metric-card success"><div class="metric-value">${h3.upgradeRate.toFixed(1)}%</div><div class="metric-label">Upgrade</div><div class="metric-delta positive">${h3.transitions.upgrade} lojas</div></div>
                <div class="metric-card warning"><div class="metric-value">${h3.maintainedRate.toFixed(1)}%</div><div class="metric-label">Mantiveram</div></div>
                <div class="metric-card danger"><div class="metric-value">${h3.downgradeRate.toFixed(1)}%</div><div class="metric-label">Downgrade</div><div class="metric-delta negative">${h3.transitions.downgrade} lojas</div></div>
            `;

            document.getElementById('h3-charts').innerHTML = `
                <div class="chart-card"><div id="h3-chart1"></div></div>
                <div class="chart-card"><div id="h3-chart2"></div></div>
            `;

            createChart('h3-chart1', [{
                values: [h3.transitions.upgrade, h3.transitions.maintained, h3.transitions.downgrade],
                labels: ['Upgrade', 'Manteve', 'Downgrade'],
                type: 'pie', hole: 0.45,
                marker: { colors: [CHART_COLORS.success, CHART_COLORS.warning, CHART_COLORS.danger] }
            }], { title: { text: 'Evolu√ß√£o de Status', font: { size: 14 } }, showlegend: false });

            const pTotal = Object.values(h3.participantsDist).reduce((a, b) => a + b, 0) || 1;
            const cTotal = Object.values(h3.controlDist).reduce((a, b) => a + b, 0) || 1;
            createChart('h3-chart2', [
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: STATUS_LIST.map(s => ((h3.participantsDist[s] || 0) / pTotal * 100)), type: 'bar', name: 'Participantes', marker: { color: CHART_COLORS.primary } },
                { x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: STATUS_LIST.map(s => ((h3.controlDist[s] || 0) / cTotal * 100)), type: 'bar', name: 'Controle', marker: { color: CHART_COLORS.secondary } }
            ], { title: { text: 'Distribui√ß√£o Status Atual (%)', font: { size: 14 } }, barmode: 'group', yaxis: { ticksuffix: '%' } });

            // Matriz de transi√ß√£o
            if (Object.keys(h3.transitionMatrix).length > 0) {
                const matrixValues = STATUS_LIST.map(from => STATUS_LIST.map(to => h3.transitionMatrix[from]?.[to] || 0));
                document.getElementById('h3-matrix').innerHTML = '<div class="chart-card full-width"><div id="h3-heatmap"></div></div>';
                createChart('h3-heatmap', [{
                    z: matrixValues, x: STATUS_LIST.map(s => STATUS_LABELS[s]), y: STATUS_LIST.map(s => STATUS_LABELS[s]),
                    type: 'heatmap', colorscale: [[0, '#F7F7F8'], [0.5, '#E6F0FF'], [1, '#0066E5']],
                    text: matrixValues.map(row => row.map(v => v > 0 ? v : '')), texttemplate: '%{text}'
                }], { title: { text: 'Matriz de Transi√ß√£o', font: { size: 14 } }, xaxis: { title: 'Status Atual' }, yaxis: { title: 'Status no Webinar', autorange: 'reversed' }, height: 450 });
            }

            // Detalhes por status
            let detailsHTML = '<div class="charts-grid three-col">';
            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (data && data.total >= 10) detailsHTML += `<div class="chart-card"><div id="h3-detail-${status}"></div></div>`;
            });
            detailsHTML += '</div>';
            document.getElementById('h3-details').innerHTML = detailsHTML;

            STATUS_LIST.forEach(status => {
                const data = h3.transitionsByInitial[status];
                if (!data || data.total < 10) return;
                const destinations = STATUS_LIST.map(dest => ({ dest, label: STATUS_LABELS[dest], pct: data.total > 0 ? ((data.destinations[dest] || 0) / data.total * 100) : 0 })).filter(d => d.pct > 0);
                createChart(`h3-detail-${status}`, [{
                    x: destinations.map(d => d.label), y: destinations.map(d => d.pct), type: 'bar',
                    marker: { color: destinations.map(d => { const from = STATUS_ORDER[status], to = STATUS_ORDER[d.dest]; return to > from ? CHART_COLORS.success : to < from ? CHART_COLORS.danger : CHART_COLORS.warning; }) },
                    text: destinations.map(d => d.pct.toFixed(1) + '%'), textposition: 'outside'
                }], { title: { text: `De ${STATUS_LABELS[status]} (${data.total})`, font: { size: 13 } }, yaxis: { ticksuffix: '%' } });
            });
        }

        function renderProfile() {
            const p = REPORT_DATA.profile;
            document.getElementById('profile-metrics').innerHTML = `
                <div class="metric-card"><div class="metric-value">${p.totalParticipants.toLocaleString()}</div><div class="metric-label">Participantes</div></div>
                <div class="metric-card"><div class="metric-value">${Math.round(p.ageStats.mean)} dias</div><div class="metric-label">Idade M√©dia</div></div>
                <div class="metric-card"><div class="metric-value">${Math.round(p.timeToFirstSellerStats.mean)} dias</div><div class="metric-label">Tempo at√© FS</div></div>
            `;

            document.getElementById('profile-charts').innerHTML = `
                <div class="chart-card"><div id="profile-chart1"></div></div>
                <div class="chart-card"><div id="profile-chart2"></div></div>
                <div class="chart-card"><div id="profile-chart3"></div></div>
                <div class="chart-card"><div id="profile-chart4"></div></div>
            `;

            const totalAge = Object.values(p.ageCategories).reduce((a, b) => a + b, 0) || 1;
            const agePct = Object.entries(p.ageCategories).map(([k, v]) => ({ label: k, pct: v / totalAge * 100 }));
            createChart('profile-chart1', [{
                x: agePct.map(a => a.label), y: agePct.map(a => a.pct), type: 'bar',
                marker: { color: CHART_COLORS.primary },
                text: agePct.map(a => a.pct.toFixed(1) + '%'), textposition: 'outside'
            }], { title: { text: 'Idade da Loja (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });

            const totalTime = Object.values(p.timeCategories).reduce((a, b) => a + b, 0) || 1;
            const timePct = Object.entries(p.timeCategories).map(([k, v]) => ({ label: k, pct: v / totalTime * 100 }));
            createChart('profile-chart2', [{
                x: timePct.map(t => t.label), y: timePct.map(t => t.pct), type: 'bar',
                marker: { color: CHART_COLORS.success },
                text: timePct.map(t => t.pct.toFixed(1) + '%'), textposition: 'outside'
            }], { title: { text: 'Tempo at√© First Seller (%)', font: { size: 14 } }, yaxis: { ticksuffix: '%' } });

            const statusLabels = Object.keys(p.statusAtWebinar).filter(s => p.statusAtWebinar[s] > 0);
            createChart('profile-chart3', [{
                labels: statusLabels.map(s => STATUS_LABELS[s] || s),
                values: statusLabels.map(s => p.statusAtWebinar[s]),
                type: 'pie', marker: { colors: statusLabels.map(s => STATUS_COLORS[s] || CHART_COLORS.secondary) }
            }], { title: { text: 'Status no Webinar', font: { size: 14 } } });

            const partLabels = Object.keys(p.participationType).filter(k => p.participationType[k] > 0);
            createChart('profile-chart4', [{
                labels: partLabels.map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                values: partLabels.map(k => p.participationType[k]),
                type: 'pie', marker: { colors: [CHART_COLORS.primary, '#8B5CF6', '#A78BFA', '#C4B5FD'] }
            }], { title: { text: 'Tipo de Participa√ß√£o', font: { size: 14 } } });

            document.getElementById('profile-insights').innerHTML = `<div class="summary-box">
                <h4>üìã Insights</h4>
                <p>Idade m√©dia das lojas: <strong>${Math.round(p.ageStats.mean)} dias</strong> (${(p.ageStats.mean/365).toFixed(1)} anos)<br>
                Tempo m√©dio at√© First Seller: <strong>${Math.round(p.timeToFirstSellerStats.mean)} dias</strong></p>
            </div>`;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toFixed(2);
        }

        // ============================================================
        // INICIALIZA√á√ÉO
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            renderQuickStats();
            updateApiStatus();
        });
    </script>
</body>
</html>
